<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SQL for Data Analysis using R - 3&nbsp; Time Series Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter_4.html" rel="next">
<link href="./chapter_2.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Time Series Analysis</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">SQL for Data Analysis using R</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Analysis with SQL</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Preparing Data for Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_3.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Time Series Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_4.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cohorts</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Text Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_6.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Anomaly Detection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_7.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Experiment Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_8.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Creating Complex Data Sets for Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_9.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Conclusion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#date-datetime-and-time-manipulations" id="toc-date-datetime-and-time-manipulations" class="nav-link active" data-scroll-target="#date-datetime-and-time-manipulations"><span class="toc-section-number">3.1</span>  Date, Datetime, and Time Manipulations</a>
  <ul class="collapse">
  <li><a href="#time-zone-conversions" id="toc-time-zone-conversions" class="nav-link" data-scroll-target="#time-zone-conversions"><span class="toc-section-number">3.1.1</span>  Time Zone Conversions</a></li>
  <li><a href="#date-and-timestamp-format-conversions" id="toc-date-and-timestamp-format-conversions" class="nav-link" data-scroll-target="#date-and-timestamp-format-conversions"><span class="toc-section-number">3.1.2</span>  Date and Timestamp Format Conversions</a></li>
  <li><a href="#date-math" id="toc-date-math" class="nav-link" data-scroll-target="#date-math"><span class="toc-section-number">3.1.3</span>  Date Math</a></li>
  <li><a href="#time-math" id="toc-time-math" class="nav-link" data-scroll-target="#time-math"><span class="toc-section-number">3.1.4</span>  Time Math</a></li>
  <li><a href="#joining-data-from-different-sources" id="toc-joining-data-from-different-sources" class="nav-link" data-scroll-target="#joining-data-from-different-sources"><span class="toc-section-number">3.1.5</span>  Joining Data from Different Sources</a></li>
  </ul></li>
  <li><a href="#sec-retail-data" id="toc-sec-retail-data" class="nav-link" data-scroll-target="#sec-retail-data"><span class="toc-section-number">3.2</span>  The Retail Sales Data Set</a></li>
  <li><a href="#trending-the-data" id="toc-trending-the-data" class="nav-link" data-scroll-target="#trending-the-data"><span class="toc-section-number">3.3</span>  Trending the Data</a>
  <ul class="collapse">
  <li><a href="#simple-trends" id="toc-simple-trends" class="nav-link" data-scroll-target="#simple-trends"><span class="toc-section-number">3.3.1</span>  Simple Trends</a></li>
  <li><a href="#comparing-components" id="toc-comparing-components" class="nav-link" data-scroll-target="#comparing-components"><span class="toc-section-number">3.3.2</span>  Comparing Components</a></li>
  <li><a href="#percent-of-total-calculations" id="toc-percent-of-total-calculations" class="nav-link" data-scroll-target="#percent-of-total-calculations"><span class="toc-section-number">3.3.3</span>  Percent of Total Calculations</a></li>
  <li><a href="#indexing-to-see-percent-change-over-time" id="toc-indexing-to-see-percent-change-over-time" class="nav-link" data-scroll-target="#indexing-to-see-percent-change-over-time"><span class="toc-section-number">3.3.4</span>  Indexing to See Percent Change over Time</a></li>
  </ul></li>
  <li><a href="#rolling-time-windows" id="toc-rolling-time-windows" class="nav-link" data-scroll-target="#rolling-time-windows"><span class="toc-section-number">3.4</span>  Rolling Time Windows</a>
  <ul class="collapse">
  <li><a href="#calculating-rolling-time-windows" id="toc-calculating-rolling-time-windows" class="nav-link" data-scroll-target="#calculating-rolling-time-windows"><span class="toc-section-number">3.4.1</span>  Calculating Rolling Time Windows</a></li>
  <li><a href="#calculating-cumulative-values" id="toc-calculating-cumulative-values" class="nav-link" data-scroll-target="#calculating-cumulative-values"><span class="toc-section-number">3.4.2</span>  Calculating Cumulative Values</a></li>
  </ul></li>
  <li><a href="#analyzing-with-seasonality" id="toc-analyzing-with-seasonality" class="nav-link" data-scroll-target="#analyzing-with-seasonality"><span class="toc-section-number">3.5</span>  Analyzing with Seasonality</a>
  <ul class="collapse">
  <li><a href="#period-over-period-comparisons-yoy-and-mom" id="toc-period-over-period-comparisons-yoy-and-mom" class="nav-link" data-scroll-target="#period-over-period-comparisons-yoy-and-mom"><span class="toc-section-number">3.5.1</span>  Period-over-Period Comparisons: YoY and MoM</a></li>
  <li><a href="#period-over-period-comparisons-same-month-versus-last-year" id="toc-period-over-period-comparisons-same-month-versus-last-year" class="nav-link" data-scroll-target="#period-over-period-comparisons-same-month-versus-last-year"><span class="toc-section-number">3.5.2</span>  Period-over-Period Comparisons: Same Month Versus Last Year</a></li>
  <li><a href="#comparing-to-multiple-prior-periods" id="toc-comparing-to-multiple-prior-periods" class="nav-link" data-scroll-target="#comparing-to-multiple-prior-periods"><span class="toc-section-number">3.5.3</span>  Comparing to Multiple Prior Periods</a></li>
  </ul></li>
  <li><a href="#persistent-storage" id="toc-persistent-storage" class="nav-link" data-scroll-target="#persistent-storage"><span class="toc-section-number">3.6</span>  Persistent storage</a>
  <ul class="collapse">
  <li><a href="#using-postgresql" id="toc-using-postgresql" class="nav-link" data-scroll-target="#using-postgresql"><span class="toc-section-number">3.6.1</span>  Using PostgreSQL</a></li>
  <li><a href="#read-only-databases" id="toc-read-only-databases" class="nav-link" data-scroll-target="#read-only-databases"><span class="toc-section-number">3.6.2</span>  Read-only databases</a></li>
  <li><a href="#closing-the-database-connection" id="toc-closing-the-database-connection" class="nav-link" data-scroll-target="#closing-the-database-connection"><span class="toc-section-number">3.6.3</span>  Closing the database connection</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-time-series" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Time Series Analysis</span></span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>This chapter is really two chapters. The first part of the chapter discusses some finer details of dates, date-times, and time stamps. This material is important, but a little technical and bewildering wihtout some concrete use cases.</p>
<p>The second part of the chapter is where <span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="references.html#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span> really starts to take off. This is where it starts playing around with real data. A first-time reader could probably skip ahead to <a href="#sec-retail-data"><span>Section&nbsp;3.2</span></a> without much loss.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dbplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="date-datetime-and-time-manipulations" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="date-datetime-and-time-manipulations"><span class="header-section-number">3.1</span> Date, Datetime, and Time Manipulations</h2>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>INSTALL <span class="st">'icu'</span>;</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>LOAD <span class="st">'icu'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="time-zone-conversions" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="time-zone-conversions"><span class="header-section-number">3.1.1</span> Time Zone Conversions</h3>
<p><span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="references.html#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span> points out that often “timestamps in the database are not encoded with the time zone, and you will need to consult with the source or developer to figure out how your data was stored.” When pushing data to a PostgreSQL database, I use the <code>timestamp with time zone</code> type as much as possible.</p>
<p><span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="references.html#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span> provides the following example, which is interesting because the west coast of the United States would not be on the PST time zone at that time of year. Instead, it would be on PDT.</p>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> timestamptz <span class="st">'2020-09-01 00:00:00 -0'</span> <span class="kw">AT</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="st">'PST'</span> <span class="kw">AS</span> <span class="dt">time</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-08-31 17:00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In PostgreSQL, we would get a different answer with the following query, but in DuckDB it seems that <code>PDT</code> is not recognized as a time zone abbreviation at all, so we just get the original UTC timestamp back.</p>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> timestamptz <span class="st">'2020-09-01 00:00:00 -0'</span> <span class="kw">AT</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="st">'PDT'</span> <span class="kw">AS</span> <span class="dt">time</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-09-01</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>I think most people barely know the difference between PST and PDT and even fewer would know the exact dates that one switches from one to the other. A better approach is to use a time zone that encodes information about when PDT is used and when PST is used. In PostgreSQL and DuckDB, the function <code>pg_timezone_names()</code> returns a table with the information that we need.</p>
<p>However, it seems that there are inconsistencies between PostgreSQL and DuckDB in terms of the abbreviations used. As such it’s probably safer to use the <code>name</code> form (e.g., <code>US/Pacific</code>) whenever possible. Given the widespread confusion about the meaning of terms like <code>EST</code>, <code>EDT</code>, and so on, just use <code>US/Eastern</code>, etc.</p>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> name, abbrev</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> pg_timezone_names()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> regexp_matches(name, <span class="st">'^US/'</span>);</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- use WHERE name ~ '^US/'; in PostgreSQL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">abbrev</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">US/Alaska</td>
<td style="text-align: left;">AST</td>
</tr>
<tr class="even">
<td style="text-align: left;">US/Aleutian</td>
<td style="text-align: left;">US/Aleutian</td>
</tr>
<tr class="odd">
<td style="text-align: left;">US/Arizona</td>
<td style="text-align: left;">PNT</td>
</tr>
<tr class="even">
<td style="text-align: left;">US/Central</td>
<td style="text-align: left;">CST</td>
</tr>
<tr class="odd">
<td style="text-align: left;">US/East-Indiana</td>
<td style="text-align: left;">IET</td>
</tr>
<tr class="even">
<td style="text-align: left;">US/Eastern</td>
<td style="text-align: left;">US/Eastern</td>
</tr>
<tr class="odd">
<td style="text-align: left;">US/Hawaii</td>
<td style="text-align: left;">US/Hawaii</td>
</tr>
<tr class="even">
<td style="text-align: left;">US/Indiana-Starke</td>
<td style="text-align: left;">US/Indiana-Starke</td>
</tr>
<tr class="odd">
<td style="text-align: left;">US/Michigan</td>
<td style="text-align: left;">US/Michigan</td>
</tr>
<tr class="even">
<td style="text-align: left;">US/Mountain</td>
<td style="text-align: left;">Navajo</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The following queries demonstrate that daylight savings information is encoded in the database.</p>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">'2020-09-01 17:00:01 US/Pacific'</span>:<span class="ch">:timestamptz</span> <span class="kw">AS</span> t1,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>       <span class="st">'2020-09-02 10:00:01 Australia/Melbourne'</span>:<span class="ch">:timestamptz</span>  <span class="kw">AS</span> t2;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">t1</th>
<th style="text-align: left;">t2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-09-02 00:00:01</td>
<td style="text-align: left;">2020-09-02 00:00:01</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="st">'2020-12-01 16:00:01 US/Pacific'</span>:<span class="ch">:timestamptz</span> <span class="kw">AS</span> t1,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>       <span class="st">'2020-12-02 11:00:01 Australia/Melbourne'</span>:<span class="ch">:timestamptz</span>  <span class="kw">AS</span> t2;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">t1</th>
<th style="text-align: left;">t2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-12-02 00:00:01</td>
<td style="text-align: left;">2020-12-02 00:00:01</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"(SELECT     </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">    '2020-12-01 16:00:01 US/Pacific'::timestamptz AS t1)"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>a_time <span class="ot">&lt;-</span> <span class="fu">tbl</span>(db, <span class="fu">sql</span>(sql))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>a_time <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">t1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-12-02 00:00:01</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>a_time_r <span class="ot">&lt;-</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  a_time <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(t1) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(a_time_r, <span class="at">tz =</span> <span class="st">"UTC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-12-02 00:00:01 UTC"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(a_time_r, <span class="at">tz =</span> <span class="st">"US/Pacific"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-12-01 16:00:01 PST"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.timezone</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Australia/Melbourne"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(a_time_r, <span class="at">tz =</span> <span class="fu">Sys.timezone</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-12-02 11:00:01 AEDT"</code></pre>
</div>
</div>
<p>The above examples illustrate a few key ideas.</p>
<p>First, while we supply the literal form <code>'2020-09-01 17:00:01 US/Pacific'::timestamptz</code>, it seems that once a variable has been encoded as <code>TIMESTAMP WITH TIME ZONE</code>, it behaves as though it is actually being <em>stored</em> as a timestamp in the UTC time zone, just with the <em>displayed</em> time perhaps being different.</p>
<p>Second, columns of type <code>TIMESTAMP WITH TIME ZONE</code> come into R with the associated time-zone information, which is what we want (especially if we will later put timestamp data back into PostgreSQL).</p>
<p>Third, we can see that we can choose to <em>display</em> information in a different time zone without changing the underlying data.</p>
<p>Some care is needed with timestamp data. I think the <code>AT TIME ZONE</code> queries provided in <span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="references.html#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span> are actually pretty dangerous, as can be seen in the following query. While we supply <code>2020-09-01 00:00:01</code> as UTC and then render it <code>AT TIME ZONE 'US/Pacific'</code>, it turns out that the returned value is interpreted as a <code>TIMESTAMP WITHOUT TIME ZONE</code> and subsequent queries lead to confusing behaviour. In the query below, the second application of <code>AT TIME ZONE</code> interprets the <code>TIMESTAMP WITHOUT TIME ZONE</code> as though it came from the stated time zone and the results seem to have <code>AT TIME ZONE</code> doing the opposite of what it did when given a <code>TIMESTAMP WITH TIME ZONE</code> (as in the initial literal <code>'2020-09-01 00:00:01 -0'</code>).</p>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> q1 <span class="kw">AS</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a> (<span class="kw">SELECT</span> timestamptz <span class="st">'2020-09-01 00:00:01-00'</span> <span class="kw">AT</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="st">'US/Pacific'</span> <span class="kw">AS</span> t1,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>         <span class="dt">timestamp</span> <span class="st">'2020-09-01 00:00:01'</span> <span class="kw">AT</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="st">'US/Pacific'</span> <span class="kw">AS</span> t2)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  t1,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  t1:<span class="ch">:varchar</span> <span class="kw">AS</span> t1_char,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  t1 <span class="kw">AT</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="st">'UTC'</span> <span class="kw">AS</span> t3,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  t2 <span class="kw">AT</span> <span class="dt">TIME</span> <span class="dt">ZONE</span> <span class="st">'UTC'</span> <span class="kw">AS</span> t4,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  typeof(t1),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  typeof(t2)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> q1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>1 records</caption>
<colgroup>
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 9%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">t1</th>
<th style="text-align: left;">t1_char</th>
<th style="text-align: left;">t3</th>
<th style="text-align: left;">t4</th>
<th style="text-align: left;">typeof(t1)</th>
<th style="text-align: left;">typeof(t2)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-08-31 17:00:01</td>
<td style="text-align: left;">2020-08-31 17:00:01</td>
<td style="text-align: left;">2020-08-31 17:00:01</td>
<td style="text-align: left;">2020-09-01 07:00:01</td>
<td style="text-align: left;">TIMESTAMP</td>
<td style="text-align: left;">TIMESTAMP WITH TIME ZONE</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>It seems that <code>TIMESTAMP WITHOUT TIME ZONE</code> values should be converted to a time zone as quickly as possible to avoid confusion and that care is needed with <code>AT TIME ZONE</code> given that it does very different (essentially opposite) things according to the supplied data type.</p>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> q1 <span class="kw">AS</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a> (<span class="kw">SELECT</span> <span class="st">'2020-09-01 00:00:01-00'</span>:<span class="ch">:timestamptz</span> <span class="kw">AS</span> t1)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t1,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  t1:<span class="ch">:varchar</span> <span class="kw">AS</span> t2,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  typeof(t1)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> q1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">t1</th>
<th style="text-align: left;">t2</th>
<th style="text-align: left;">typeof(t1)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-09-01 00:00:01</td>
<td style="text-align: left;">2020-09-01 10:00:01+10</td>
<td style="text-align: left;">TIMESTAMP WITH TIME ZONE</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Strange behaviour can result from values stored as <code>TIMESTAMP WITHOUT TIME ZONE</code>. Below we see that <code>t1</code> is printed as UTC no matter what, while the behaviour of <code>t2</code> seems easier to understand.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>sql <span class="ot">&lt;-</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"(SELECT     </span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="st">    '2020-12-01 00:00:01-00' AS t1,</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="st">    '2020-12-01 00:00:01-00'::timestamptz AS t2)"</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>two_times_notz <span class="ot">&lt;-</span> <span class="fu">tbl</span>(db, <span class="fu">sql</span>(sql))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>two_times_notz <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">t1</th>
<th style="text-align: left;">t2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-12-01 00:00:01-00</td>
<td style="text-align: left;">2020-12-01 00:00:01</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>two_times_notz_r <span class="ot">&lt;-</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(two_times_notz)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(two_times_notz_r<span class="sc">$</span>t1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-12-01 00:00:01-00"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.timezone</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Australia/Melbourne"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(two_times_notz_r<span class="sc">$</span>t1, <span class="at">tz =</span> <span class="fu">Sys.timezone</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-12-01 00:00:01-00"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(two_times_notz_r<span class="sc">$</span>t2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-12-01 00:00:01 UTC"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.timezone</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Australia/Melbourne"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(two_times_notz_r<span class="sc">$</span>t2, <span class="at">tz =</span> <span class="fu">Sys.timezone</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-12-01 11:00:01 AEDT"</code></pre>
</div>
</div>
<p>As pointed out by <span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="references.html#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span>, one drawback to storing information as UTC is that localtime information may be lost. But it seems it would be more prudent to store information as <code>TIMESTAMP WITH TIME ZONE</code> and keep local time zone information as a separate column to avoid confusion. For example, if the <code>orders</code> table is stored as <code>TIMESTAMP WITHOUT TIME ZONE</code> based on the local time of the customer, which might be <code>Australia/Melbourne</code> and the <code>shipping</code> table uses <code>TIMESTAMP WITH TIME ZONE</code>, then an analyst of time-to-ship data would be confused by orders apparently being shipped before they are made. If <code>shipping</code> table uses <code>TIMESTAMP WITH TIME ZONE</code> using timestamps in the time zone of the East Bay warehouse (so <code>US/Pacific</code>), things would be even worse.</p>
<p>I think that fully fleshing out the issues here would require a separate chapter. In fact, nothing in the core part of Chapter 3 of <span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="references.html#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span> (which focuses on the <code>retail_sales</code> table) really uses timestamp information, so we can put these issues aside for now.</p>
</section>
<section id="date-and-timestamp-format-conversions" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="date-and-timestamp-format-conversions"><span class="header-section-number">3.1.2</span> Date and Timestamp Format Conversions</h3>
<p>As discussed in <span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="references.html#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span>, PostgreSQL has a rich array of functions for converting dates and times and extracting such information as months and days of the week.</p>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> date_trunc(<span class="st">'month'</span>,<span class="st">'2020-10-04 12:33:35 -00'</span>:<span class="ch">:timestamptz</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>1 records</caption>
<colgroup>
<col style="width: 100%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">date_trunc(‘month’, CAST(‘2020-10-04 12:33:35 -00’ AS TIMESTAMP WITH TIME ZONE))</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2020-09-30 14:00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>One such function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>a_time_df <span class="ot">&lt;-</span> <span class="fu">tbl</span>(db, <span class="fu">sql</span>(<span class="st">"(SELECT '2020-10-04 12:33:35'::timestamp AS a_time)"</span>))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>a_time_df <span class="sc">%&gt;%</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">a_trunced_time =</span> <span class="fu">date_trunc</span>(<span class="st">'month'</span>, a_time))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [1 x 2]
# Database: DuckDB 0.7.1 [igow@Darwin 22.5.0:R 4.2.2/:memory:]
  a_time              a_trunced_time
  &lt;dttm&gt;              &lt;date&gt;        
1 2020-10-04 12:33:35 2020-10-01    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>a_time_df <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">a_trunced_time =</span> <span class="fu">date_trunc</span>(<span class="st">'month'</span>, a_time)) <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT *, date_trunc('month', a_time) AS a_trunced_time
FROM (SELECT '2020-10-04 12:33:35'::timestamp AS a_time)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>a_time_df <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  a_time             
  &lt;dttm&gt;             
1 2020-10-04 12:33:35</code></pre>
</div>
</div>
</section>
<section id="date-math" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="date-math"><span class="header-section-number">3.1.3</span> Date Math</h3>
</section>
<section id="time-math" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="time-math"><span class="header-section-number">3.1.4</span> Time Math</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>a_time_df <span class="ot">&lt;-</span> <span class="fu">tbl</span>(db, <span class="fu">sql</span>(<span class="st">"(SELECT '2020-10-04 12:33:35 US/Pacific'::timestamptz AS a_time)"</span>))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>a_time_df <span class="sc">%&gt;%</span> </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">a_trunced_time =</span> <span class="fu">date_trunc</span>(<span class="st">'month'</span>, a_time)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Source:   SQL [1 x 2]
# Database: DuckDB 0.7.1 [igow@Darwin 22.5.0:R 4.2.2/:memory:]
  a_time              a_trunced_time     
  &lt;dttm&gt;              &lt;dttm&gt;             
1 2020-10-04 19:33:35 2020-09-30 14:00:00</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>a_time_df <span class="sc">%&gt;%</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">a_trunced_time =</span> <span class="fu">date_trunc</span>(<span class="st">'month'</span>, a_time)) <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT *, date_trunc('month', a_time) AS a_trunced_time
FROM (SELECT '2020-10-04 12:33:35 US/Pacific'::timestamptz AS a_time)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>a_time_df <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  a_time             
  &lt;dttm&gt;             
1 2020-10-04 19:33:35</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>a_time_df <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_time =</span> a_time <span class="sc">+</span> <span class="fu">sql</span>(<span class="st">"interval '3 hours'"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  a_time              new_time           
  &lt;dttm&gt;              &lt;dttm&gt;             
1 2020-10-04 19:33:35 2020-10-04 22:33:35</code></pre>
</div>
</div>
</section>
<section id="joining-data-from-different-sources" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="joining-data-from-different-sources"><span class="header-section-number">3.1.5</span> Joining Data from Different Sources</h3>
</section>
</section>
<section id="sec-retail-data" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-retail-data"><span class="header-section-number">3.2</span> The Retail Sales Data Set</h2>
<p>As discussed in <span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="references.html#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span>, the data set used in this chapter comes from the website of the US Census Bureau. The data set is a little messy, but not too large, so we can easily grab it directly from the website and clean it up in much the same way that Cathy has done for us.</p>
<div class="cell" data-hash="chapter_3_cache/html/unnamed-chunk-22_afbadf70659e6629e25732c46813b072">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use tmpdir = "." or known directory if you have trouble with </span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># this part.</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>mrtssales <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".xlsx"</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.census.gov/retail/mrts/www/"</span>,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"mrtssales92-present.xlsx"</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(url, mrtssales)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>read_tab <span class="ot">&lt;-</span> <span class="cf">function</span>(year) {</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initially we read all columns as text, as we want to process</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># more precise than read_excel() would do unsupervised.</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(mrtssales,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">range =</span> <span class="st">"A4:N71"</span>, </span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sheet =</span> <span class="fu">as.character</span>(year),</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">col_types =</span> <span class="st">"text"</span>,</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">col_names =</span> <span class="fu">paste0</span>(<span class="st">"v"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>))</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The third row has the dates for columns 3:14</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(temp) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"naics_code"</span>, <span class="st">"kind_of_business"</span>,</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">as.character</span>(temp[<span class="dv">2</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">14</span>]))</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The actual data are found after row 3</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> temp[<span class="sc">-</span><span class="dv">1</span><span class="sc">:-</span><span class="dv">3</span>, ]</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Now pivot the data and convert sales to numeric values.</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Also convert sales_month to dates (start of respective month).</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    temp <span class="sc">%&gt;%</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">names_to =</span> <span class="st">"sales_month"</span>,</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"sales"</span>,</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cols =</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">:-</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sales_month =</span> <span class="fu">paste</span>(<span class="st">"01"</span>, <span class="fu">str_remove</span>(sales_month, <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>)),</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>           <span class="at">sales_month =</span> <span class="fu">as.Date</span>(sales_month, <span class="st">"%d %b %Y"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">reason_for_null =</span> <span class="fu">case_when</span>(sales <span class="sc">==</span> <span class="st">"(NA)"</span> <span class="sc">~</span> <span class="st">"Not Available"</span>,</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>                                       sales <span class="sc">==</span> <span class="st">"(S)"</span> <span class="sc">~</span> <span class="st">"Supressed"</span>,</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>                                       <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span>),</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>           <span class="at">sales =</span> <span class="fu">case_when</span>(sales <span class="sc">==</span> <span class="st">"(NA)"</span> <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>                             sales <span class="sc">==</span> <span class="st">"(S)"</span> <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>                             <span class="cn">TRUE</span> <span class="sc">~</span> sales)) <span class="sc">%&gt;%</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sales =</span> <span class="fu">as.double</span>(sales)) <span class="sc">%&gt;%</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sales_month, naics_code, kind_of_business,</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>           reason_for_null, sales)</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>  df</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>retail_sales_local <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">lapply</span>(<span class="dv">1992</span><span class="sc">:</span><span class="dv">2020</span>, read_tab)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, we could just grab a CSV file from the GitHub repository for <span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="references.html#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span>.</p>
<div class="cell" data-hash="chapter_3_cache/html/unnamed-chunk-23_6a4ea78e812a8009961b5c156d0472ea">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://raw.githubusercontent.com/"</span>,</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>              <span class="st">"cathytanimura/sql_book/master/"</span>,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Chapter%203%3A%20Time%20Series%20Analysis/"</span>,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>              <span class="st">"us_retail_sales.csv"</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>retail_sales_local <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(url, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that there are differences between the two versions of <code>retail_sales_local</code> above, as US Census economic data is continually being revised even after being released.</p>
<p>Now that we have the data in R, a few questions arise.</p>
<p>First, why would we move it to a database? Second, how can we move it to a database? Related to the previous question will be: which database to we want to move it to?</p>
<p>Taking these questions in turn, the first one is a good question. With <code>retail_sales</code> as a local data frame, we can run almost all the analyses below with only the slightest modifications. The modifications needed are to replace every instance of <code>window_order()</code> with <code>arrange()</code>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> The “almost all” relates to the moving average, which relies on <code>window_frame()</code> from <code>dbplyr</code>, which has no exact equivalent in <code>dplyr</code>.</p>
<p>So the first point is that “almost all” implies an advantage for using <code>dbplyr</code>. On occasion, the SQL engine provided by PostgreSQL will allow us to do some data manipulations more easily than we can in R. But of course, there are many cases when the opposite is true. That said, why not have both? Store data in a database and <code>collect()</code> as necessary to do things that R is better at?</p>
<p>Second, performance can be better using SQL. Compiling a version of this chapter using <code>dplyr</code> with a local data frame for the remainder took just under 14 seconds. Using a PostgreSQL backend, it took 8.5 seconds. Adding back in the queries with <code>window_order()</code> that I removed so that I could compile with <code>dplyr</code> and using DuckDB as the backend, the document took 8.3 seconds to compile (this beat out PostgreSQL doing the same in 9.6 seconds). While these differences are not practically very significant, they could be with more demanding tasks. Also, a database will not always beat R or Python for performance, but often will and having the option to use a database backend is a good thing.</p>
<p>Third, having the data in a database allows you to interrogate the data using SQL. If you are more familiar with SQL, or just know how to do a particular task in SQL, this can be beneficial.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>Fourth, I think there is merit in separating the tasks of acquiring and cleaning data from the task of analysing those data. Many data analysts have a work flow that entails ingesting and cleaning data for each analysis task. My experience is that it is often better to do the ingesting and cleaning once and then reuse the cleaned data in subsequent analyses. A common pattern involves reusing the same data in many analyses and it can be helpful to divide the tasks in a way that using an SQL database encourages. Also the skills in ingesting and cleaning data can be different from those for analysing those data, so sometimes it makes sense for one person to do one task, push the data to a database, and then have someone else do some or all of the analysis.</p>
<p>Regarding the second question, there are a few options. But for this chapter we will use <code>duckdb</code></p>
<p>To install DuckDB, all we have to do is <code>install.packages("duckdb")</code>.</p>
<p>Then we can create a connection as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we use the default of an in-memory database. At the end of this chapter, we discuss how we could store the data in a file (say, <code>legislators.duckdb</code>) if we want persistent storage.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="ot">&lt;-</span> <span class="fu">copy_to</span>(db, retail_sales_local, <span class="st">"retail_sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="trending-the-data" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="trending-the-data"><span class="header-section-number">3.3</span> Trending the Data</h2>
<section id="simple-trends" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="simple-trends"><span class="header-section-number">3.3.1</span> Simple Trends</h3>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> sales_month, sales</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> kind_of_business <span class="op">=</span> <span class="st">'Retail and food services sales, total'</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">146376</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: right;">147079</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-03-01</td>
<td style="text-align: right;">159336</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-04-01</td>
<td style="text-align: right;">163669</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-05-01</td>
<td style="text-align: right;">170068</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-06-01</td>
<td style="text-align: right;">168663</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">169890</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-08-01</td>
<td style="text-align: right;">170364</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-09-01</td>
<td style="text-align: right;">164617</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-10-01</td>
<td style="text-align: right;">173655</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">'Retail and food services sales, total'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, sales) <span class="sc">%&gt;%</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_month, <span class="at">y =</span> sales)) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> date_part(<span class="st">'year'</span>,sales_month) <span class="kw">as</span> sales_year,</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(sales) <span class="kw">as</span> sales</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> kind_of_business <span class="op">=</span> <span class="st">'Retail and food services sales, total'</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sales_year</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992</td>
<td style="text-align: right;">2014102</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993</td>
<td style="text-align: right;">2153095</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1994</td>
<td style="text-align: right;">2330235</td>
</tr>
<tr class="even">
<td style="text-align: left;">1995</td>
<td style="text-align: right;">2450628</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1996</td>
<td style="text-align: right;">2603794</td>
</tr>
<tr class="even">
<td style="text-align: left;">1997</td>
<td style="text-align: right;">2726131</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1998</td>
<td style="text-align: right;">2852956</td>
</tr>
<tr class="even">
<td style="text-align: left;">1999</td>
<td style="text-align: right;">3086990</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2000</td>
<td style="text-align: right;">3287537</td>
</tr>
<tr class="even">
<td style="text-align: left;">2001</td>
<td style="text-align: right;">3378906</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">'Retail and food services sales, total'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sales_year =</span> <span class="fu">year</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_year, <span class="at">y =</span> sales)) <span class="sc">+</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> date_part(<span class="st">'year'</span>,sales_month) <span class="kw">as</span> sales_year, </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  kind_of_business, <span class="fu">sum</span>(sales) <span class="kw">as</span> sales</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> kind_of_business <span class="kw">IN</span> </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>          (<span class="st">'Book stores'</span>,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>           <span class="st">'Sporting goods stores'</span>,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>           <span class="st">'Hobby, toy, and game stores'</span>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>,<span class="dv">2</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: right;">sales_year</th>
<th style="text-align: left;">kind_of_business</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1992</td>
<td style="text-align: left;">Book stores</td>
<td style="text-align: right;">8327</td>
</tr>
<tr class="even">
<td style="text-align: right;">1992</td>
<td style="text-align: left;">Sporting goods stores</td>
<td style="text-align: right;">15583</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1992</td>
<td style="text-align: left;">Hobby, toy, and game stores</td>
<td style="text-align: right;">11251</td>
</tr>
<tr class="even">
<td style="text-align: right;">1993</td>
<td style="text-align: left;">Book stores</td>
<td style="text-align: right;">9108</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1993</td>
<td style="text-align: left;">Sporting goods stores</td>
<td style="text-align: right;">16791</td>
</tr>
<tr class="even">
<td style="text-align: right;">1993</td>
<td style="text-align: left;">Hobby, toy, and game stores</td>
<td style="text-align: right;">11651</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1994</td>
<td style="text-align: left;">Book stores</td>
<td style="text-align: right;">10107</td>
</tr>
<tr class="even">
<td style="text-align: right;">1994</td>
<td style="text-align: left;">Sporting goods stores</td>
<td style="text-align: right;">18825</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1994</td>
<td style="text-align: left;">Hobby, toy, and game stores</td>
<td style="text-align: right;">12850</td>
</tr>
<tr class="even">
<td style="text-align: right;">1995</td>
<td style="text-align: left;">Book stores</td>
<td style="text-align: right;">11196</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="comparing-components" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="comparing-components"><span class="header-section-number">3.3.2</span> Comparing Components</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">%in%</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">c</span>(<span class="st">'Book stores'</span>,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Sporting goods stores'</span>,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>             <span class="st">'Hobby, toy, and game stores'</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sales_year =</span> <span class="fu">year</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_year, kind_of_business) <span class="sc">%&gt;%</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_year, <span class="at">y =</span> sales, <span class="at">color =</span> kind_of_business)) <span class="sc">+</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> sales_month, kind_of_business, sales</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> kind_of_business <span class="kw">IN</span> (<span class="st">'Men</span><span class="ch">''</span><span class="st">s clothing stores'</span>,<span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>,<span class="dv">2</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: left;">kind_of_business</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">701</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">1873</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">658</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">1991</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-03-01</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">731</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-03-01</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">2403</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-04-01</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">816</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-04-01</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">2665</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-05-01</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">856</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-05-01</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">2752</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Men's clothing stores"</span>,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"Women's clothing stores"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, kind_of_business, sales) <span class="sc">%&gt;%</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_month, <span class="at">y =</span> sales, <span class="at">color =</span> kind_of_business)) <span class="sc">+</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> date_part(<span class="st">'year'</span>,sales_month) <span class="kw">as</span> sales_year,</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  kind_of_business, <span class="fu">sum</span>(sales) <span class="kw">as</span> sales</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> kind_of_business <span class="kw">IN</span> </span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'Men</span><span class="ch">''</span><span class="st">s clothing stores'</span>,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span>)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: right;">sales_year</th>
<th style="text-align: left;">kind_of_business</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1992</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">10179</td>
</tr>
<tr class="even">
<td style="text-align: right;">1992</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">31815</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1993</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">9962</td>
</tr>
<tr class="even">
<td style="text-align: right;">1993</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">32350</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1994</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">10032</td>
</tr>
<tr class="even">
<td style="text-align: right;">1994</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">30585</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1995</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">9315</td>
</tr>
<tr class="even">
<td style="text-align: right;">1995</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">28696</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1996</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">9546</td>
</tr>
<tr class="even">
<td style="text-align: right;">1996</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">28238</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">%in%</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">c</span>(<span class="st">"Men's clothing stores"</span>,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Women's clothing stores"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sales_year =</span> <span class="fu">year</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_year, kind_of_business) <span class="sc">%&gt;%</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_year, <span class="at">y =</span> sales, <span class="at">color =</span> kind_of_business)) <span class="sc">+</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> date_part(<span class="st">'year'</span>, sales_month) <span class="kw">AS</span> sales_year,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> kind_of_business <span class="op">=</span> <span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>          <span class="cf">then</span> sales </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>          <span class="cf">END</span>) <span class="kw">AS</span> womens_sales,</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> kind_of_business <span class="op">=</span> <span class="st">'Men</span><span class="ch">''</span><span class="st">s clothing stores'</span> </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>          <span class="cf">then</span> sales </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>          <span class="cf">END</span>) <span class="kw">AS</span> mens_sales</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> kind_of_business <span class="kw">IN</span> </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>   (<span class="st">'Men</span><span class="ch">''</span><span class="st">s clothing stores'</span>,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span>)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sales_year</th>
<th style="text-align: right;">womens_sales</th>
<th style="text-align: right;">mens_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992</td>
<td style="text-align: right;">31815</td>
<td style="text-align: right;">10179</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993</td>
<td style="text-align: right;">32350</td>
<td style="text-align: right;">9962</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1994</td>
<td style="text-align: right;">30585</td>
<td style="text-align: right;">10032</td>
</tr>
<tr class="even">
<td style="text-align: left;">1995</td>
<td style="text-align: right;">28696</td>
<td style="text-align: right;">9315</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1996</td>
<td style="text-align: right;">28238</td>
<td style="text-align: right;">9546</td>
</tr>
<tr class="even">
<td style="text-align: left;">1997</td>
<td style="text-align: right;">27822</td>
<td style="text-align: right;">10069</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1998</td>
<td style="text-align: right;">28332</td>
<td style="text-align: right;">10196</td>
</tr>
<tr class="even">
<td style="text-align: left;">1999</td>
<td style="text-align: right;">29549</td>
<td style="text-align: right;">9667</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2000</td>
<td style="text-align: right;">31447</td>
<td style="text-align: right;">9507</td>
</tr>
<tr class="even">
<td style="text-align: left;">2001</td>
<td style="text-align: right;">31453</td>
<td style="text-align: right;">8625</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>pivoted_sales <span class="ot">&lt;-</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">%in%</span> </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">c</span>(<span class="st">"Men's clothing stores"</span>,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Women's clothing stores"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kind_of_business =</span> <span class="fu">if_else</span>(kind_of_business <span class="sc">==</span> <span class="st">"Women's clothing stores"</span>,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"womens"</span>, <span class="st">"mens"</span>),</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">sales_year =</span> <span class="fu">year</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_year, kind_of_business) <span class="sc">%&gt;%</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="st">"sales_year"</span>,</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> <span class="st">"kind_of_business"</span>,</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_glue =</span> <span class="st">"{kind_of_business}_{.value}"</span>,</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> <span class="st">"sales"</span>)  </span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>pivoted_sales <span class="sc">%&gt;%</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT
  sales_year,
  MAX(CASE WHEN (kind_of_business = 'mens') THEN sales END) AS mens_sales,
  MAX(CASE WHEN (kind_of_business = 'womens') THEN sales END) AS womens_sales
FROM (
  SELECT sales_year, kind_of_business, SUM(sales) AS sales
  FROM (
    SELECT
      sales_month,
      naics_code,
      CASE WHEN (kind_of_business = 'Women''s clothing stores') THEN 'womens' WHEN NOT (kind_of_business = 'Women''s clothing stores') THEN 'mens' END AS kind_of_business,
      reason_for_null,
      sales,
      EXTRACT(year FROM sales_month) AS sales_year
    FROM retail_sales
    WHERE (kind_of_business IN ('Men''s clothing stores', 'Women''s clothing stores'))
  ) q01
  GROUP BY sales_year, kind_of_business
) q02
GROUP BY sales_year</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>pivoted_sales <span class="sc">%&gt;%</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">sales_year</th>
<th style="text-align: right;">mens_sales</th>
<th style="text-align: right;">womens_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1992</td>
<td style="text-align: right;">10179</td>
<td style="text-align: right;">31815</td>
</tr>
<tr class="even">
<td style="text-align: right;">1993</td>
<td style="text-align: right;">9962</td>
<td style="text-align: right;">32350</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1994</td>
<td style="text-align: right;">10032</td>
<td style="text-align: right;">30585</td>
</tr>
<tr class="even">
<td style="text-align: right;">1995</td>
<td style="text-align: right;">9315</td>
<td style="text-align: right;">28696</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1996</td>
<td style="text-align: right;">9546</td>
<td style="text-align: right;">28238</td>
</tr>
<tr class="even">
<td style="text-align: right;">1997</td>
<td style="text-align: right;">10069</td>
<td style="text-align: right;">27822</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1998</td>
<td style="text-align: right;">10196</td>
<td style="text-align: right;">28332</td>
</tr>
<tr class="even">
<td style="text-align: right;">1999</td>
<td style="text-align: right;">9667</td>
<td style="text-align: right;">29549</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2000</td>
<td style="text-align: right;">9507</td>
<td style="text-align: right;">31447</td>
</tr>
<tr class="even">
<td style="text-align: right;">2001</td>
<td style="text-align: right;">8625</td>
<td style="text-align: right;">31453</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>pivoted_sales <span class="sc">%&gt;%</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sales_year <span class="sc">&lt;=</span> <span class="dv">2019</span>) <span class="sc">%&gt;%</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">womens_minus_mens =</span> womens_sales <span class="sc">-</span> mens_sales,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">mens_minus_womens =</span> mens_sales <span class="sc">-</span> womens_sales) <span class="sc">%&gt;%</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_year, womens_minus_mens, mens_minus_womens) <span class="sc">%&gt;%</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> womens_minus_mens, <span class="at">x =</span> sales_year)) <span class="sc">+</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>pivoted_sales <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sales_year <span class="sc">&lt;=</span> <span class="dv">2019</span>) <span class="sc">%&gt;%</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">womens_times_of_mens =</span> womens_sales <span class="sc">/</span> mens_sales) <span class="sc">%&gt;%</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> womens_times_of_mens, <span class="at">x =</span> sales_year)) <span class="sc">+</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>pivoted_sales <span class="sc">%&gt;%</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sales_year <span class="sc">&lt;=</span> <span class="dv">2019</span>) <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">womens_pct_of_mens =</span> (womens_sales <span class="sc">/</span> mens_sales <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> womens_pct_of_mens, <span class="at">x =</span> sales_year)) <span class="sc">+</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="percent-of-total-calculations" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="percent-of-total-calculations"><span class="header-section-number">3.3.3</span> Percent of Total Calculations</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">%in%</span> </span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">c</span>(<span class="st">"Men's clothing stores"</span>,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Women's clothing stores"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))  <span class="sc">%&gt;%</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_total_sales =</span> sales <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> total_sales) <span class="sc">%&gt;%</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, kind_of_business, pct_total_sales) <span class="sc">%&gt;%</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: left;">kind_of_business</th>
<th style="text-align: right;">pct_total_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992-06-01</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">26.02991</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-06-01</td>
<td style="text-align: left;">Women’s clothing stores</td>
<td style="text-align: right;">73.97009</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-08-01</td>
<td style="text-align: left;">Men’s clothing stores</td>
<td style="text-align: right;">22.62667</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">%in%</span> </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">c</span>(<span class="st">"Men's clothing stores"</span>,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Women's clothing stores"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_total_sales =</span> sales <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> total_sales) <span class="sc">%&gt;%</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;SQL&gt;
SELECT *, (sales * 100.0) / total_sales AS pct_total_sales
FROM (
  SELECT *, SUM(sales) OVER (PARTITION BY sales_month) AS total_sales
  FROM retail_sales
  WHERE (kind_of_business IN ('Men''s clothing stores', 'Women''s clothing stores'))
) q01</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">%in%</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">c</span>(<span class="st">"Men's clothing stores"</span>,</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Women's clothing stores"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_total_sales =</span> sales <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> total_sales) <span class="sc">%&gt;%</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> pct_total_sales, <span class="at">x =</span> sales_month, <span class="at">color =</span> kind_of_business)) <span class="sc">+</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="indexing-to-see-percent-change-over-time" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="indexing-to-see-percent-change-over-time"><span class="header-section-number">3.3.4</span> Indexing to See Percent Change over Time</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">"Women's clothing stores"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sales_year =</span> <span class="fu">year</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">index_sales =</span> <span class="fu">first</span>(sales),</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_from_index =</span> (sales<span class="sc">/</span>index_sales <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">sales_year</th>
<th style="text-align: right;">sales</th>
<th style="text-align: right;">index_sales</th>
<th style="text-align: right;">pct_from_index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1992</td>
<td style="text-align: right;">31815</td>
<td style="text-align: right;">31815</td>
<td style="text-align: right;">0.000000</td>
</tr>
<tr class="even">
<td style="text-align: right;">1993</td>
<td style="text-align: right;">32350</td>
<td style="text-align: right;">31815</td>
<td style="text-align: right;">1.681597</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1994</td>
<td style="text-align: right;">30585</td>
<td style="text-align: right;">31815</td>
<td style="text-align: right;">-3.866101</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Women's clothing stores"</span>,</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"Men's clothing stores"</span>),</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>         sales_month <span class="sc">&lt;=</span> <span class="st">'2019-12-31'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sales_year =</span> <span class="fu">year</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(kind_of_business, sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(kind_of_business) <span class="sc">%&gt;%</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">index_sales =</span> <span class="fu">first</span>(sales),</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_from_index =</span> (sales<span class="sc">/</span>index_sales <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> pct_from_index, <span class="at">x =</span> sales_year, <span class="at">color =</span> kind_of_business)) <span class="sc">+</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="rolling-time-windows" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="rolling-time-windows"><span class="header-section-number">3.4</span> Rolling Time Windows</h2>
<section id="calculating-rolling-time-windows" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="calculating-rolling-time-windows"><span class="header-section-number">3.4.1</span> Calculating Rolling Time Windows</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>mvg_avg <span class="ot">&lt;-</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">"Women's clothing stores"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_frame</span>(<span class="sc">-</span><span class="dv">11</span>, <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">moving_avg =</span> <span class="fu">mean</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">records_count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sales_month <span class="sc">&gt;=</span> <span class="st">'1993-01-01'</span>) </span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>mvg_avg <span class="sc">%&gt;%</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, moving_avg, records_count) <span class="sc">%&gt;%</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">moving_avg</th>
<th style="text-align: right;">records_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">2672.08</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: right;">2673.25</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-03-01</td>
<td style="text-align: right;">2676.50</td>
<td style="text-align: right;">12</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>mvg_avg <span class="sc">%&gt;%</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_month)) <span class="sc">+</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sales, <span class="at">colour =</span> <span class="st">"Sales"</span>)) <span class="sc">+</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> moving_avg, <span class="at">colour =</span> <span class="st">"Moving average"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  sales_month,</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">avg</span>(sales) <span class="kw">over</span> w <span class="kw">AS</span> moving_avg,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(sales) <span class="kw">over</span> w <span class="kw">AS</span> records_count</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> kind_of_business <span class="op">=</span> <span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>WINDOW w <span class="kw">AS</span> (<span class="kw">order</span> <span class="kw">by</span> sales_month </span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>             <span class="kw">rows</span> <span class="kw">between</span> <span class="dv">11</span> <span class="kw">preceding</span> <span class="kw">and</span> <span class="kw">current</span> <span class="kw">row</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">moving_avg</th>
<th style="text-align: right;">records_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">1873.000</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: right;">1932.000</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-03-01</td>
<td style="text-align: right;">2089.000</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-04-01</td>
<td style="text-align: right;">2233.000</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-05-01</td>
<td style="text-align: right;">2336.800</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-06-01</td>
<td style="text-align: right;">2351.333</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2354.429</td>
<td style="text-align: right;">7</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-08-01</td>
<td style="text-align: right;">2392.250</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-09-01</td>
<td style="text-align: right;">2410.889</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-10-01</td>
<td style="text-align: right;">2445.300</td>
<td style="text-align: right;">10</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">"Women's clothing stores"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_frame</span>(<span class="sc">-</span><span class="dv">11</span>, <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">moving_avg =</span> <span class="fu">mean</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">records_count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, moving_avg, records_count) <span class="sc">%&gt;%</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>date_dim <span class="ot">&lt;-</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">'1993-01-01'</span>), </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">as.Date</span>(<span class="st">'2020-12-01'</span>), </span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="st">"1 month"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy_to</span>(db, ., <span class="at">overwrite =</span> <span class="cn">TRUE</span>, <span class="at">name =</span> <span class="st">"date_dim"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> jan_jul <span class="kw">AS</span> (</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> sales_month, sales</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> retail_sales </span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> kind_of_business <span class="op">=</span> <span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>     <span class="kw">AND</span> date_part(<span class="st">'month'</span>, sales_month) <span class="kw">IN</span> (<span class="dv">1</span>, <span class="dv">7</span>))</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> a.<span class="dt">date</span>, b.sales_month, b.sales</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> date_dim a</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> jan_jul b </span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ON</span> b.sales_month <span class="kw">BETWEEN</span> a.<span class="dt">date</span> <span class="op">-</span> <span class="dt">interval</span> <span class="st">'11 months'</span> <span class="kw">AND</span> a.<span class="dt">date</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> a.<span class="dt">date</span> <span class="kw">BETWEEN</span> <span class="st">'1993-01-01'</span> <span class="kw">AND</span> <span class="st">'2020-12-01'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">date</th>
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2373</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2373</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-03-01</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2373</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-04-01</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2373</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-05-01</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2373</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-06-01</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2373</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">2123</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">2123</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-03-01</td>
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">2123</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-04-01</td>
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">2123</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>jan_jul <span class="ot">&lt;-</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">"Women's clothing stores"</span>,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">month</span>(sales_month) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, sales)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>date_dim <span class="sc">%&gt;%</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_start =</span> date <span class="sc">-</span> <span class="fu">months</span>(<span class="dv">11</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(jan_jul, </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="fu">between</span>(y<span class="sc">$</span>sales_month, x<span class="sc">$</span>date_start, x<span class="sc">$</span>date))) <span class="sc">%&gt;%</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, sales_month, sales) <span class="sc">%&gt;%</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">date</th>
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2373</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2373</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-03-01</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">2373</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>date_dim <span class="sc">%&gt;%</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_start =</span> date <span class="sc">-</span> <span class="fu">months</span>(<span class="dv">11</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(jan_jul, </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="fu">between</span>(y<span class="sc">$</span>sales_month, x<span class="sc">$</span>date_start, x<span class="sc">$</span>date))) <span class="sc">%&gt;%</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">moving_avg =</span> <span class="fu">mean</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">records =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">date</th>
<th style="text-align: right;">moving_avg</th>
<th style="text-align: right;">records</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">2248</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: right;">2248</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-03-01</td>
<td style="text-align: right;">2248</td>
<td style="text-align: right;">2</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> sales_months <span class="kw">AS</span> (</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="kw">distinct</span> sales_month</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> retail_sales</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> sales_month <span class="kw">between</span> <span class="st">'1993-01-01'</span> <span class="kw">and</span> <span class="st">'2020-12-01'</span>)</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> a.sales_month, <span class="fu">avg</span>(b.sales) <span class="kw">as</span> moving_avg</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> sales_months a</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> retail_sales b </span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="kw">on</span> b.sales_month <span class="kw">between</span> </span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    a.sales_month <span class="op">-</span> <span class="dt">interval</span> <span class="st">'11 months'</span> <span class="kw">and</span> a.sales_month</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">and</span> b.kind_of_business <span class="op">=</span> <span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span> </span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">3</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">moving_avg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">2672.083</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: right;">2673.250</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-03-01</td>
<td style="text-align: right;">2676.500</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>sales_months <span class="ot">&lt;-</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">between</span>(sales_month, </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">as.Date</span>(<span class="st">'1993-01-01'</span>), </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">as.Date</span>(<span class="st">'2020-12-01'</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sales_month)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>sales_months <span class="sc">%&gt;%</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month_start =</span> sales_month <span class="sc">-</span> <span class="fu">months</span>(<span class="dv">11</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(retail_sales, </span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="fu">between</span>(y<span class="sc">$</span>sales_month, x<span class="sc">$</span>month_start, x<span class="sc">$</span>sales_month)),</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_y"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">"Women's clothing stores"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">moving_avg =</span> <span class="fu">mean</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">moving_avg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">2672.083</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: right;">2673.250</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-03-01</td>
<td style="text-align: right;">2676.500</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="calculating-cumulative-values" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="calculating-cumulative-values"><span class="header-section-number">3.4.2</span> Calculating Cumulative Values</h3>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> sales_month, sales,</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(sales) <span class="kw">OVER</span> w <span class="kw">AS</span> sales_ytd</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> kind_of_business <span class="op">=</span> <span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>WINDOW w <span class="kw">AS</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> date_part(<span class="st">'year'</span>, sales_month) </span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>             <span class="kw">ORDER</span> <span class="kw">BY</span> sales_month)</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">3</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>3 records</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: right;">sales_ytd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2017-01-01</td>
<td style="text-align: right;">2454</td>
<td style="text-align: right;">2454</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-02-01</td>
<td style="text-align: right;">2763</td>
<td style="text-align: right;">5217</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-03-01</td>
<td style="text-align: right;">3485</td>
<td style="text-align: right;">8702</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>ytd_sales <span class="ot">&lt;-</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">"Women's clothing stores"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sales_ytd =</span> <span class="fu">cumsum</span>(sales)) <span class="sc">%&gt;%</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, sales, sales_ytd) </span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>ytd_sales <span class="sc">%&gt;%</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">month</span>(sales_month) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">12</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: right;">sales_ytd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2017-01-01</td>
<td style="text-align: right;">2454</td>
<td style="text-align: right;">2454</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-01</td>
<td style="text-align: right;">2511</td>
<td style="text-align: right;">2511</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-02-01</td>
<td style="text-align: right;">2763</td>
<td style="text-align: right;">5217</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-02-01</td>
<td style="text-align: right;">2680</td>
<td style="text-align: right;">5191</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2017-03-01</td>
<td style="text-align: right;">3485</td>
<td style="text-align: right;">8702</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-03-01</td>
<td style="text-align: right;">3585</td>
<td style="text-align: right;">8776</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>factor <span class="ot">&lt;-</span> <span class="dv">40</span><span class="sc">/</span><span class="fl">4.5</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>ytd_sales <span class="sc">%&gt;%</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(sales_month) <span class="sc">%in%</span> <span class="dv">2016</span><span class="sc">:</span><span class="dv">2020</span>) <span class="sc">%&gt;%</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_month, <span class="at">y =</span> sales_ytd)) <span class="sc">+</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sales <span class="sc">*</span> factor, <span class="at">colour =</span> <span class="fu">I</span>(<span class="st">"blue"</span>))) <span class="sc">+</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sales YTD"</span>, </span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sec.axis =</span> <span class="fu">sec_axis</span>(<span class="sc">~</span> . <span class="sc">/</span> factor, <span class="at">name =</span> <span class="st">"Monthly Sales"</span>)</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> a.sales_month, a.sales,</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(b.sales) <span class="kw">AS</span> sales_ytd</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales a</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> retail_sales b <span class="kw">ON</span> </span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a> date_part(<span class="st">'year'</span>,a.sales_month) <span class="op">=</span> date_part(<span class="st">'year'</span>,b.sales_month)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a> <span class="kw">AND</span> b.sales_month <span class="op">&lt;=</span> a.sales_month</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">AND</span> b.kind_of_business <span class="op">=</span> <span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> a.kind_of_business <span class="op">=</span> <span class="st">'Women</span><span class="ch">''</span><span class="st">s clothing stores'</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>,<span class="dv">2</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: right;">sales_ytd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992-12-01</td>
<td style="text-align: right;">4416</td>
<td style="text-align: right;">31815</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-12-01</td>
<td style="text-align: right;">4170</td>
<td style="text-align: right;">32350</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-11-01</td>
<td style="text-align: right;">2946</td>
<td style="text-align: right;">27399</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-11-01</td>
<td style="text-align: right;">2923</td>
<td style="text-align: right;">28180</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-10-01</td>
<td style="text-align: right;">2755</td>
<td style="text-align: right;">24453</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-10-01</td>
<td style="text-align: right;">2713</td>
<td style="text-align: right;">25257</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-09-01</td>
<td style="text-align: right;">2560</td>
<td style="text-align: right;">21698</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-09-01</td>
<td style="text-align: right;">2622</td>
<td style="text-align: right;">22544</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1992-08-01</td>
<td style="text-align: right;">2657</td>
<td style="text-align: right;">19138</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-08-01</td>
<td style="text-align: right;">2626</td>
<td style="text-align: right;">19922</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>retail_sales_yr <span class="ot">&lt;-</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(sales_month))</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>retail_sales_yr <span class="sc">%&gt;%</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">"Women's clothing stores"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(retail_sales_yr, </span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(year, kind_of_business,</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>                     sales_month <span class="sc">&gt;=</span> sales_month),</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_y"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_month, sales) <span class="sc">%&gt;%</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">sales_ytd =</span> <span class="fu">sum</span>(sales_y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">month</span>(sales_month) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">12</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: right;">sales_ytd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: right;">1991</td>
<td style="text-align: right;">3864</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: right;">2005</td>
<td style="text-align: right;">4128</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1994-02-01</td>
<td style="text-align: right;">1970</td>
<td style="text-align: right;">3756</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-03-01</td>
<td style="text-align: right;">2403</td>
<td style="text-align: right;">6267</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-03-01</td>
<td style="text-align: right;">2442</td>
<td style="text-align: right;">6570</td>
</tr>
<tr class="even">
<td style="text-align: left;">1994-03-01</td>
<td style="text-align: right;">2560</td>
<td style="text-align: right;">6316</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="analyzing-with-seasonality" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="analyzing-with-seasonality"><span class="header-section-number">3.5</span> Analyzing with Seasonality</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Jewelry stores"</span>,</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"Book stores"</span>,</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"Grocery stores"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_month, <span class="at">y =</span> sales)) <span class="sc">+</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(kind_of_business), <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="period-over-period-comparisons-yoy-and-mom" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="period-over-period-comparisons-yoy-and-mom"><span class="header-section-number">3.5.1</span> Period-over-Period Comparisons: YoY and MoM</h3>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> kind_of_business, sales_month, sales,</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lag</span>(sales_month) <span class="kw">OVER</span> w <span class="kw">AS</span> prev_month,</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lag</span>(sales) <span class="kw">OVER</span> w <span class="kw">AS</span> prev_month_sales</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retail_sales</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> kind_of_business <span class="op">=</span> <span class="st">'Book stores'</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>WINDOW w <span class="kw">AS</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> kind_of_business <span class="kw">ORDER</span> <span class="kw">BY</span> sales_month)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">kind_of_business</th>
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: left;">prev_month</th>
<th style="text-align: right;">prev_month_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">790</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: right;">539</td>
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">790</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-03-01</td>
<td style="text-align: right;">535</td>
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: right;">539</td>
</tr>
<tr class="even">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-04-01</td>
<td style="text-align: right;">523</td>
<td style="text-align: left;">1992-03-01</td>
<td style="text-align: right;">535</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-05-01</td>
<td style="text-align: right;">552</td>
<td style="text-align: left;">1992-04-01</td>
<td style="text-align: right;">523</td>
</tr>
<tr class="even">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-06-01</td>
<td style="text-align: right;">589</td>
<td style="text-align: left;">1992-05-01</td>
<td style="text-align: right;">552</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">592</td>
<td style="text-align: left;">1992-06-01</td>
<td style="text-align: right;">589</td>
</tr>
<tr class="even">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-08-01</td>
<td style="text-align: right;">894</td>
<td style="text-align: left;">1992-07-01</td>
<td style="text-align: right;">592</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-09-01</td>
<td style="text-align: right;">861</td>
<td style="text-align: left;">1992-08-01</td>
<td style="text-align: right;">894</td>
</tr>
<tr class="even">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-10-01</td>
<td style="text-align: right;">645</td>
<td style="text-align: left;">1992-09-01</td>
<td style="text-align: right;">861</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>books_w_lag <span class="ot">&lt;-</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">'Book stores'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(kind_of_business) <span class="sc">%&gt;%</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prev_month =</span> <span class="fu">lag</span>(sales_month),</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">prev_month_sales =</span> <span class="fu">lag</span>(sales)) <span class="sc">%&gt;%</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(kind_of_business,</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>         sales_month, sales,</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>         prev_month, prev_month_sales)</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>books_w_lag <span class="sc">%&gt;%</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">kind_of_business</th>
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: left;">prev_month</th>
<th style="text-align: right;">prev_month_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">790</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: right;">539</td>
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">790</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Book stores</td>
<td style="text-align: left;">1992-03-01</td>
<td style="text-align: right;">535</td>
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: right;">539</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>books_monthly <span class="ot">&lt;-</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  books_w_lag <span class="sc">%&gt;%</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_growth =</span> (sales <span class="sc">/</span> prev_month_sales <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>prev_month, <span class="sc">-</span>prev_month_sales)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>books_yearly <span class="ot">&lt;-</span> </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">'Book stores'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sales_year =</span> <span class="fu">year</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">yearly_sales =</span> <span class="fu">sum</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_year) <span class="sc">%&gt;%</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prev_year_sales =</span> <span class="fu">lag</span>(yearly_sales),</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_growth =</span> (yearly_sales<span class="sc">/</span>prev_year_sales <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>books_yearly <span class="sc">%&gt;%</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">sales_year</th>
<th style="text-align: right;">yearly_sales</th>
<th style="text-align: right;">prev_year_sales</th>
<th style="text-align: right;">pct_growth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1992</td>
<td style="text-align: right;">8327</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1993</td>
<td style="text-align: right;">9108</td>
<td style="text-align: right;">8327</td>
<td style="text-align: right;">9.38</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1994</td>
<td style="text-align: right;">10107</td>
<td style="text-align: right;">9108</td>
<td style="text-align: right;">10.97</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>books_monthly <span class="sc">%&gt;%</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pct_growth)) <span class="sc">%&gt;%</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_month, <span class="at">y =</span> pct_growth)) <span class="sc">+</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="period-over-period-comparisons-same-month-versus-last-year" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="period-over-period-comparisons-same-month-versus-last-year"><span class="header-section-number">3.5.2</span> Period-over-Period Comparisons: Same Month Versus Last Year</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>books_lagged_year_month <span class="ot">&lt;-</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">'Book stores'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">month</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">%&gt;%</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prev_year_month =</span> <span class="fu">lag</span>(sales_month),</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">prev_year_sales =</span> <span class="fu">lag</span>(sales)) <span class="sc">%&gt;%</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, sales, prev_year_month, prev_year_sales)</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>books_lagged_year_month <span class="sc">%&gt;%</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">month</span>(sales_month) <span class="sc">&lt;=</span> <span class="dv">2</span>, </span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>         <span class="fu">year</span>(sales_month) <span class="sc">&lt;=</span> <span class="dv">1994</span>) <span class="sc">%&gt;%</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: left;">prev_year_month</th>
<th style="text-align: right;">prev_year_sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">790</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: right;">539</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">998</td>
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">790</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: right;">568</td>
<td style="text-align: left;">1992-02-01</td>
<td style="text-align: right;">539</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1994-01-01</td>
<td style="text-align: right;">1053</td>
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">998</td>
</tr>
<tr class="even">
<td style="text-align: left;">1994-02-01</td>
<td style="text-align: right;">635</td>
<td style="text-align: left;">1993-02-01</td>
<td style="text-align: right;">568</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>books_lagged_year_month <span class="sc">%&gt;%</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dollar_diff =</span> sales <span class="sc">-</span> prev_year_sales,</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_diff =</span> dollar_diff<span class="sc">/</span>prev_year_sales <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>prev_year_month, <span class="sc">-</span>prev_year_sales) <span class="sc">%&gt;%</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">month</span>(sales_month) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: right;">dollar_diff</th>
<th style="text-align: right;">pct_diff</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">790</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">998</td>
<td style="text-align: right;">208</td>
<td style="text-align: right;">26.33</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1994-01-01</td>
<td style="text-align: right;">1053</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">5.51</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>books_lagged_year_month <span class="sc">%&gt;%</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(prev_year_sales)) <span class="sc">%&gt;%</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dollar_diff =</span> sales <span class="sc">-</span> prev_year_sales,</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_diff =</span> dollar_diff<span class="sc">/</span>prev_year_sales <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, sales, dollar_diff, pct_diff) <span class="sc">%&gt;%</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">fct_inorder</span>(name)) <span class="sc">%&gt;%</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sales_month, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> name, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">scales =</span> <span class="st">"free"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>With PostgreSQL, we would use <code>to_char(sales_month,'Month')</code>; with DuckDB, the equivalent is <code>monthname(sales_month)</code>. To use an approach that works with either backend, we draw on arguments to the <code>lubridate</code> function <code>month()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>sales_92_94 <span class="ot">&lt;-</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">'Book stores'</span>,</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">year</span>(sales_month) <span class="sc">%in%</span> <span class="dv">1992</span><span class="sc">:</span><span class="dv">1994</span>) <span class="sc">%&gt;%</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, sales) <span class="sc">%&gt;%</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month_number =</span> <span class="fu">month</span>(sales_month),</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">month_name =</span> <span class="fu">month</span>(sales_month, </span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">FALSE</span>),</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">as.integer</span>(<span class="fu">year</span>(sales_month)))</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>sales_92_94 <span class="sc">%&gt;%</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(month_number, month_name),</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> year,</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_prefix =</span> <span class="st">"sales_"</span>,</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> sales) <span class="sc">%&gt;%</span></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">month_number</th>
<th style="text-align: left;">month_name</th>
<th style="text-align: right;">sales_1992</th>
<th style="text-align: right;">sales_1993</th>
<th style="text-align: right;">sales_1994</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">January</td>
<td style="text-align: right;">790</td>
<td style="text-align: right;">998</td>
<td style="text-align: right;">1053</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">February</td>
<td style="text-align: right;">539</td>
<td style="text-align: right;">568</td>
<td style="text-align: right;">635</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">March</td>
<td style="text-align: right;">535</td>
<td style="text-align: right;">602</td>
<td style="text-align: right;">634</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">April</td>
<td style="text-align: right;">523</td>
<td style="text-align: right;">583</td>
<td style="text-align: right;">610</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">May</td>
<td style="text-align: right;">552</td>
<td style="text-align: right;">612</td>
<td style="text-align: right;">684</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">June</td>
<td style="text-align: right;">589</td>
<td style="text-align: right;">618</td>
<td style="text-align: right;">724</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">July</td>
<td style="text-align: right;">592</td>
<td style="text-align: right;">607</td>
<td style="text-align: right;">678</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">August</td>
<td style="text-align: right;">894</td>
<td style="text-align: right;">983</td>
<td style="text-align: right;">1154</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">September</td>
<td style="text-align: right;">861</td>
<td style="text-align: right;">903</td>
<td style="text-align: right;">1022</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">October</td>
<td style="text-align: right;">645</td>
<td style="text-align: right;">669</td>
<td style="text-align: right;">732</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: left;">November</td>
<td style="text-align: right;">642</td>
<td style="text-align: right;">692</td>
<td style="text-align: right;">772</td>
</tr>
<tr class="even">
<td style="text-align: right;">12</td>
<td style="text-align: left;">December</td>
<td style="text-align: right;">1165</td>
<td style="text-align: right;">1273</td>
<td style="text-align: right;">1409</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>sales_92_94 <span class="sc">%&gt;%</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">factor</span>(year),</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">month_name =</span> <span class="fu">month</span>(month_number, <span class="at">label =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> month_name, <span class="at">y =</span> sales, </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">group =</span> year, <span class="at">colour =</span> year)) <span class="sc">+</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_3_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="comparing-to-multiple-prior-periods" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="comparing-to-multiple-prior-periods"><span class="header-section-number">3.5.3</span> Comparing to Multiple Prior Periods</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>prev_three <span class="ot">&lt;-</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">'Book stores'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">month</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">%&gt;%</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prev_sales_1 =</span> <span class="fu">lag</span>(sales, <span class="dv">1</span>),</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">prev_sales_2 =</span> <span class="fu">lag</span>(sales, <span class="dv">2</span>),</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">prev_sales_3 =</span> <span class="fu">lag</span>(sales, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>prev_three <span class="sc">%&gt;%</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, sales, <span class="fu">starts_with</span>(<span class="st">"prev_sales"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: right;">prev_sales_1</th>
<th style="text-align: right;">prev_sales_2</th>
<th style="text-align: right;">prev_sales_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1992-01-01</td>
<td style="text-align: right;">790</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">1993-01-01</td>
<td style="text-align: right;">998</td>
<td style="text-align: right;">790</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1994-01-01</td>
<td style="text-align: right;">1053</td>
<td style="text-align: right;">998</td>
<td style="text-align: right;">790</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">1995-01-01</td>
<td style="text-align: right;">1308</td>
<td style="text-align: right;">1053</td>
<td style="text-align: right;">998</td>
<td style="text-align: right;">790</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1996-01-01</td>
<td style="text-align: right;">1373</td>
<td style="text-align: right;">1308</td>
<td style="text-align: right;">1053</td>
<td style="text-align: right;">998</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>prev_three <span class="sc">%&gt;%</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_prev_three =</span> (prev_sales_1 <span class="sc">+</span> </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>                         prev_sales_2 <span class="sc">+</span> </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>                         prev_sales_3)<span class="sc">/</span><span class="dv">3</span>,</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_of_prev_3 =</span> <span class="dv">100</span> <span class="sc">*</span> sales<span class="sc">/</span>avg_prev_three) <span class="sc">%&gt;%</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, sales, pct_of_prev_3) <span class="sc">%&gt;%</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">month</span>(sales_month) <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>         <span class="fu">year</span>(sales_month) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1995</span><span class="sc">:</span><span class="dv">1997</span>, <span class="dv">2017</span><span class="sc">:</span><span class="dv">2019</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: right;">pct_of_prev_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1995-01-01</td>
<td style="text-align: right;">1308</td>
<td style="text-align: right;">138.12</td>
</tr>
<tr class="even">
<td style="text-align: left;">1996-01-01</td>
<td style="text-align: right;">1373</td>
<td style="text-align: right;">122.63</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1997-01-01</td>
<td style="text-align: right;">1558</td>
<td style="text-align: right;">125.17</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-01-01</td>
<td style="text-align: right;">1386</td>
<td style="text-align: right;">94.63</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2018-01-01</td>
<td style="text-align: right;">1217</td>
<td style="text-align: right;">84.95</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-01</td>
<td style="text-align: right;">1004</td>
<td style="text-align: right;">74.74</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>prev_three_win <span class="ot">&lt;-</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  retail_sales <span class="sc">%&gt;%</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kind_of_business <span class="sc">==</span> <span class="st">'Book stores'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> <span class="fu">month</span>(sales_month)) <span class="sc">%&gt;%</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(month) <span class="sc">%&gt;%</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(sales_month) <span class="sc">%&gt;%</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_frame</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">avg_prev_three =</span> <span class="fu">mean</span>(sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_of_prev_3 =</span> <span class="dv">100</span> <span class="sc">*</span> sales<span class="sc">/</span>avg_prev_three)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>prev_three_win <span class="sc">%&gt;%</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sales_month, sales, pct_of_prev_3) <span class="sc">%&gt;%</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">month</span>(sales_month) <span class="sc">==</span> <span class="dv">1</span>,</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">year</span>(sales_month) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1995</span><span class="sc">:</span><span class="dv">1997</span>, <span class="dv">2017</span><span class="sc">:</span><span class="dv">2019</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">sales_month</th>
<th style="text-align: right;">sales</th>
<th style="text-align: right;">pct_of_prev_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1995-01-01</td>
<td style="text-align: right;">1308</td>
<td style="text-align: right;">138.12</td>
</tr>
<tr class="even">
<td style="text-align: left;">1996-01-01</td>
<td style="text-align: right;">1373</td>
<td style="text-align: right;">122.63</td>
</tr>
<tr class="odd">
<td style="text-align: left;">1997-01-01</td>
<td style="text-align: right;">1558</td>
<td style="text-align: right;">125.17</td>
</tr>
<tr class="even">
<td style="text-align: left;">2017-01-01</td>
<td style="text-align: right;">1386</td>
<td style="text-align: right;">94.63</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2018-01-01</td>
<td style="text-align: right;">1217</td>
<td style="text-align: right;">84.95</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019-01-01</td>
<td style="text-align: right;">1004</td>
<td style="text-align: right;">74.74</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="persistent-storage" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="persistent-storage"><span class="header-section-number">3.6</span> Persistent storage</h2>
<p>Having created a database connection, we can write the local data frame to the database using (say) <code>copy_to()</code>.</p>
<p>We could specify <code>temporary = FALSE</code> if we wanted the data to be there permanently.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<section id="using-postgresql" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="using-postgresql"><span class="header-section-number">3.6.1</span> Using PostgreSQL</h3>
</section>
<section id="read-only-databases" class="level3" data-number="3.6.2">
<h3 data-number="3.6.2" class="anchored" data-anchor-id="read-only-databases"><span class="header-section-number">3.6.2</span> Read-only databases</h3>
<p>In some cases, you will have access to a database, but no write privileges for that database. In such a case, <code>copy_inline()</code> can be useful.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> Note that it seems you cannot interrogate a table created using <code>copy_inline()</code> using SQL, though it will behave in most respects just like a table created using <code>copy_to()</code> when using <code>dbplyr</code>. It is useful to note that <code>copy_inline()</code> is probably not a good solution if your data are hundreds of thousands of rows or more because the table is effectively turned into literal SQL.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>retail_sales_alt <span class="ot">&lt;-</span> <span class="fu">copy_inline</span>(db, retail_sales_local)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="closing-the-database-connection" class="level3" data-number="3.6.3">
<h3 data-number="3.6.3" class="anchored" data-anchor-id="closing-the-database-connection"><span class="header-section-number">3.6.3</span> Closing the database connection</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(db, <span class="at">shutdown=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-tanimura2021sql" class="csl-entry" role="doc-biblioentry">
Tanimura, C. 2021. <em>SQL for Data Analysis</em>. O’Reilly Media. <a href="https://books.google.com.au/books?id=ojhCEAAAQBAJ">https://books.google.com.au/books?id=ojhCEAAAQBAJ</a>.
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>I requested a tweak to <code>dplyr</code> that would have avoided the need to do this, but <a href="https://github.com/tidyverse/dbplyr/issues/627">my request was denied</a>. Given how awesome <code>dbplyr</code>/<code>dplyr</code> is, I cannot complain.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Though I will argue later that transitioning to <code>dplyr</code>/<code>dbplyr</code> is actually not difficult.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Obviously this would not make sense if <code>db</code> is a connection to an in-memory database.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>I <a href="https://github.com/tidyverse/dbplyr/issues/628">requested</a> this function for a common use case I have. Thank you to the <code>dbplyr</code> team for making it happen.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<!-- Default Statcounter code for SQL for Data Analysis with
R http://iangow.github.io/sql_book -->
<script type="text/javascript">
var sc_project=12869953; 
var sc_invisible=1; 
var sc_security="5165b474"; 
</script>
<script type="text/javascript" src="https://www.statcounter.com/counter/counter.js" async=""></script>
<noscript><div class="statcounter"><a title="Web Analytics" href="https://statcounter.com/" target="_blank"><img class="statcounter" src="https://c.statcounter.com/12869953/0/5165b474/1/" alt="Web Analytics" referrerpolicy="no-referrer-when-downgrade"></a></div></noscript>
<!-- End of Statcounter Code -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapter_2.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Preparing Data for Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter_4.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cohorts</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>