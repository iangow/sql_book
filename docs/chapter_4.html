<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>SQL for Data Analysis using R - 4&nbsp; Cohorts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter_5.html" rel="next">
<link href="./chapter_3.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cohorts</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">SQL for Data Analysis using R</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Analysis with SQL</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Preparing Data for Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Time Series Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_4.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cohorts</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Text Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_6.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Anomaly Detection</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_7.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Experiment Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_8.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Creating Complex Data Sets for Analysis</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter_9.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Conclusion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#cohorts-a-useful-analysis-framework" id="toc-cohorts-a-useful-analysis-framework" class="nav-link active" data-scroll-target="#cohorts-a-useful-analysis-framework"><span class="toc-section-number">4.1</span>  Cohorts: A Useful Analysis Framework</a></li>
  <li><a href="#the-legislators-data-set" id="toc-the-legislators-data-set" class="nav-link" data-scroll-target="#the-legislators-data-set"><span class="toc-section-number">4.2</span>  The Legislators Data Set</a></li>
  <li><a href="#adjusting-time-series-to-increase-retention-accuracy" id="toc-adjusting-time-series-to-increase-retention-accuracy" class="nav-link" data-scroll-target="#adjusting-time-series-to-increase-retention-accuracy"><span class="toc-section-number">4.3</span>  Adjusting Time Series to Increase Retention Accuracy</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cohorts</span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="cohorts-a-useful-analysis-framework" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="cohorts-a-useful-analysis-framework"><span class="header-section-number">4.1</span> Cohorts: A Useful Analysis Framework</h2>
<p>Chapter 4 examines the fascinating topic of cohorts, where a cohort is a group of observations (often people) who acquire a shared characteristic at (approximately) the same time. For example, children entering kindergarten in New Zealand in 2017 or the Harvard MBA Class of 2002.</p>
<p>While cohort analysis has some attractive features, I guess that data do not often come in a format that facilitates such analysis. Instead, as is the case with the <em>legislators</em> data set studied in Chapter 4, the data analyst needs to rearrange the data to support cohort analysis.</p>
<p>I found Chapter 4 a little confusing on a first pass through it.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> The chapter launches into some SQL code intended to create cohorts, but it’s a little unclear why we’re doing what we’re doing, and we quickly see that our cohort analysis does not make sense (e.g., we have more of our original cohort in period 5 than we had in period 4) and we must have done something wrong. I think I see the idea Cathy is going for here: one needs to think carefully about how to arrange the data to avoid subtle mistakes. The challenge I see is that it’s not obvious that everyone would make the same mistake and one is too deep in the weeds of the code to really see the forest for the trees.</p>
<p>So before I launch into the code, I will spend a little time thinking about things conceptually. I will start with a different example from that used in Chapter 4, but one that I think brings out some of the issues.</p>
<p>For some reason I associate cohort analysis with life expectancy. The people who are born today form a cohort and one might ask: How long do we expect members of this cohort to live? One often hears life expectancy statistics quoted as something like: “In Australia, a boy born in 2018–2020 can expect to live to the age of 81.2 years and a girl would be expected to live to 85.3 years compared to 51.1 for boys and 54.8 years for girls born in in 1891–1900.”<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>The people who construct the life expectancies for the children must be veritable polymaths. They need to anticipate future developments in medical care and technology. Skin cancer is a significant cause of death in Australia, due to a mismatch between the median complexion and the intensity of the sun. But the analysts calculating life expectancy need to think about how medical technology is likely to affect rates of death from carcinoma in the future. I can imagine whole-body scanners a bit like the scanners in US airports that detect skin cancers before they become problematic. These analysts also need to understand how road safety will evolve. Will children today all be in driverless vehicles in fifty years time and will accidents then be a rarity? And what about war? The data analyst needs to be able to forecast the possibility of World War III breaking out and shortening life spans. Who are these people?</p>
<p>Of course it seems unlikely these <em>über</em>-analysts exist. Rather they surely do something more prosaic. Here is my <em>guess</em> as to how life expectancies are constructed.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> I guess that the data analyst gathers data on cohorts notionally formed at some point in the past and then looks at survival rates for that cohort over some period, then aggregates those data into a life expectancy.</p>
<p>For example, the data analyst might gather data on people who turned 21 in 2018 and then data on whether those people surived to their 22nd birthday. The proportion of such people who make their 22nd birthday could be interpreted as a survival probability <span class="math inline">\(p_{21}\)</span>. Repeat that for each age-based cohort to get probabilities <span class="math inline">\(\left\{p_i: i = 0, 1, \dots, 119, 120 \right\}\)</span>. Now to find the median life expectancy, we could calculate something like this:<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p><span class="math display">\[ \left\{j: \arg \min_{i} \left(\prod_{0}^{i} p_i\right) \leq \frac{1}{2} \right\} \]</span> So we have a (fairly) well-defined procedure here. There are obviously some details to be worked out. For example, do we focus on one year (2018 in this case)? Or collect data over multiple years? Does it make sense to form cohorts by years? Or would grouping into larger cohorts (e.g., 20–25) make more sense? Do we identify people by birthdays? Or just use some kind of census date? (People who are 21 on 1 July might have just turned 21, or might be about to turn 22.)</p>
<p>But what exactly have we calculated? In a sense it’s a nonsensical number. Why would survival rates for 88-year-olds in 2018 be relevant for the life expectancy of newborns today, who will face a very different world when they turn 88 in 2111. First, perhaps the analysts really don’t calculate it in this way (though I’m doubtful they are polymaths). Second, even though it’s a “meaningless” number, it probably still has attractive properties, such as the ability to represent in a one or two numbers a lot about the quality of life in Australia.</p>
<p>A final note is that it is not clear to me where the “51.1 for boys and 54.8 years for girls born in in 1891–1900” values come from. Are these the equivalent life expectancies calculated using data available around 1900? Or are these the observed lifespans of people born in 1891–1900? If the latter, how accurate were the former as estimates of these values?</p>
</section>
<section id="the-legislators-data-set" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="the-legislators-data-set"><span class="header-section-number">4.2</span> The Legislators Data Set</h2>
<p>Now that we understand cohorts, let’s move onto the <em>legislators</em> data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dbplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(duckdb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you have the tables <code>legislators</code> and <code>legislators_terms</code> in a PostgreSQL database, then you could connect to that database.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(RPostgres<span class="sc">::</span><span class="fu">Postgres</span>(), </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">bigint =</span> <span class="st">"integer"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">check_interrupts =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Otherwise, the easiest way to get the <em>legislators</em> data set is to get the data from the GitHub site provided with <span class="citation" data-cites="tanimura2021sql">Tanimura (<a href="#ref-tanimura2021sql" role="doc-biblioref">2021</a>)</span>.</p>
<div class="cell" data-hash="chapter_4_cache/html/unnamed-chunk-4_6108dd6a9be78a37b3854077e7c146fb">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://raw.githubusercontent.com/cathytanimura/"</span>,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>              <span class="st">"sql_book/master/Chapter%204%3A%20Cohorts/"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>legislators_df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(url, <span class="st">"legislators.csv"</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>legislators_terms_df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(url, <span class="st">"legislators_terms.csv"</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>())</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>legislators <span class="ot">&lt;-</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy_to</span>(db, legislators_df, <span class="at">name =</span> <span class="st">"legislators"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>legislators_terms <span class="ot">&lt;-</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy_to</span>(db, legislators_terms_df, <span class="at">name =</span> <span class="st">"legislators_terms"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> id_bioguide, <span class="fu">min</span>(term_start) <span class="kw">AS</span> first_term</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> legislators_terms </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">id_bioguide</th>
<th style="text-align: left;">first_term</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A000001</td>
<td style="text-align: left;">1951-01-03</td>
</tr>
<tr class="even">
<td style="text-align: left;">A000002</td>
<td style="text-align: left;">1947-01-03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A000003</td>
<td style="text-align: left;">1817-12-01</td>
</tr>
<tr class="even">
<td style="text-align: left;">A000004</td>
<td style="text-align: left;">1843-12-04</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A000005</td>
<td style="text-align: left;">1887-12-05</td>
</tr>
<tr class="even">
<td style="text-align: left;">A000006</td>
<td style="text-align: left;">1868-01-01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A000007</td>
<td style="text-align: left;">1875-12-06</td>
</tr>
<tr class="even">
<td style="text-align: left;">A000008</td>
<td style="text-align: left;">1857-12-07</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A000009</td>
<td style="text-align: left;">1973-01-03</td>
</tr>
<tr class="even">
<td style="text-align: left;">A000010</td>
<td style="text-align: left;">1954-01-01</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> first_terms <span class="kw">AS</span> (</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> id_bioguide, <span class="fu">min</span>(term_start) <span class="kw">AS</span> first_term</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> legislators_terms </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>) </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> date_part(<span class="st">'year'</span>, age(b.term_start, a.first_term)) <span class="kw">AS</span> period,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> a.id_bioguide) <span class="kw">AS</span> cohort_retained</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> first_terms a</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> legislators_terms b</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">USING</span> (id_bioguide)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">period</th>
<th style="text-align: right;">cohort_retained</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: right;">12518</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: right;">3600</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2</td>
<td style="text-align: right;">3619</td>
</tr>
<tr class="even">
<td style="text-align: left;">3</td>
<td style="text-align: right;">1831</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: right;">3210</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: right;">1744</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: right;">2385</td>
</tr>
<tr class="even">
<td style="text-align: left;">7</td>
<td style="text-align: right;">1360</td>
</tr>
<tr class="odd">
<td style="text-align: left;">8</td>
<td style="text-align: right;">1607</td>
</tr>
<tr class="even">
<td style="text-align: left;">9</td>
<td style="text-align: right;">1028</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>first_terms <span class="ot">&lt;-</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  legislators_terms <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_bioguide) <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">first_term =</span> <span class="fu">min</span>(term_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>cohorts <span class="ot">&lt;-</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  legislators_terms <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(first_terms, <span class="at">by =</span> <span class="st">"id_bioguide"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">period =</span> <span class="fu">date_part</span>(<span class="st">'year'</span>, <span class="fu">age</span>(term_start, first_term))) <span class="sc">%&gt;%</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(period) <span class="sc">%&gt;%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">cohort_retained =</span> <span class="fu">sql</span>(<span class="st">"count(distinct id_bioguide)"</span>)) </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>cohorts <span class="sc">%&gt;%</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">period</th>
<th style="text-align: right;">cohort_retained</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3600</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">3619</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: right;">2385</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">1744</td>
</tr>
<tr class="odd">
<td style="text-align: right;">10</td>
<td style="text-align: right;">1398</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">3210</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1831</td>
</tr>
<tr class="even">
<td style="text-align: right;">14</td>
<td style="text-align: right;">715</td>
</tr>
<tr class="odd">
<td style="text-align: right;">12</td>
<td style="text-align: right;">1185</td>
</tr>
<tr class="even">
<td style="text-align: right;">13</td>
<td style="text-align: right;">859</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>first_terms <span class="kw">AS</span> (</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> id_bioguide, <span class="fu">min</span>(term_start) <span class="kw">AS</span> first_term</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> legislators_terms </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>cohorts <span class="kw">AS</span> (</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> date_part(<span class="st">'year'</span>, age(b.term_start, a.first_term)) <span class="kw">AS</span> period,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> a.id_bioguide) <span class="kw">AS</span> cohort_retained</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> first_terms a</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">JOIN</span> legislators_terms b </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span> (id_bioguide)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> period,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">first_value</span>(cohort_retained) <span class="kw">OVER</span> w <span class="kw">AS</span> cohort_size,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  cohort_retained,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  cohort_retained <span class="op">*</span> <span class="fl">1.0</span> <span class="op">/</span> </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">first_value</span>(cohort_retained) <span class="kw">OVER</span> w <span class="kw">AS</span> prop_retained</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> cohorts</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>WINDOW w <span class="kw">AS</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> period);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">period</th>
<th style="text-align: right;">cohort_size</th>
<th style="text-align: right;">cohort_retained</th>
<th style="text-align: right;">prop_retained</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">3600</td>
<td style="text-align: right;">0.2875859</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">3619</td>
<td style="text-align: right;">0.2891037</td>
</tr>
<tr class="even">
<td style="text-align: left;">3</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1831</td>
<td style="text-align: right;">0.1462694</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">3210</td>
<td style="text-align: right;">0.2564307</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1744</td>
<td style="text-align: right;">0.1393194</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">2385</td>
<td style="text-align: right;">0.1905256</td>
</tr>
<tr class="even">
<td style="text-align: left;">7</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1360</td>
<td style="text-align: right;">0.1086436</td>
</tr>
<tr class="odd">
<td style="text-align: left;">8</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1607</td>
<td style="text-align: right;">0.1283751</td>
</tr>
<tr class="even">
<td style="text-align: left;">9</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1028</td>
<td style="text-align: right;">0.0821217</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>retained_data <span class="ot">&lt;-</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  cohorts <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(period) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cohort_size =</span> <span class="fu">first</span>(cohort_retained)) <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_retained =</span> cohort_retained <span class="sc">*</span> <span class="fl">1.0</span><span class="sc">/</span>cohort_size) <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(period, cohort_size, cohort_retained, pct_retained) </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>retained_data <span class="sc">%&gt;%</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">period</th>
<th style="text-align: right;">cohort_size</th>
<th style="text-align: right;">cohort_retained</th>
<th style="text-align: right;">pct_retained</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1.0000000</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">3600</td>
<td style="text-align: right;">0.2875859</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">3619</td>
<td style="text-align: right;">0.2891037</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1831</td>
<td style="text-align: right;">0.1462694</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">3210</td>
<td style="text-align: right;">0.2564307</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1744</td>
<td style="text-align: right;">0.1393194</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">2385</td>
<td style="text-align: right;">0.1905256</td>
</tr>
<tr class="even">
<td style="text-align: right;">7</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1360</td>
<td style="text-align: right;">0.1086436</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1607</td>
<td style="text-align: right;">0.1283751</td>
</tr>
<tr class="even">
<td style="text-align: right;">9</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1028</td>
<td style="text-align: right;">0.0821217</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>retained_data <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> period, <span class="at">y =</span> pct_retained)) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_4_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>first_terms <span class="kw">AS</span> (</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> id_bioguide, <span class="fu">min</span>(term_start) <span class="kw">AS</span> first_term</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> legislators_terms </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>cohorts <span class="kw">AS</span> (</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> date_part(<span class="st">'year'</span>, age(b.term_start, a.first_term)) <span class="kw">AS</span> period,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">count</span>(<span class="kw">distinct</span> a.id_bioguide) <span class="kw">as</span> cohort_retained</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> first_terms a</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">JOIN</span> legislators_terms b <span class="kw">on</span> a.id_bioguide <span class="op">=</span> b.id_bioguide </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>retained_data <span class="kw">AS</span> (</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> period,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">first_value</span>(cohort_retained) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> period) <span class="kw">AS</span> cohort_size,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    cohort_retained,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    cohort_retained <span class="op">*</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="fu">first_value</span>(cohort_retained) <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> period) <span class="kw">AS</span> pct_retained</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> cohorts)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> cohort_size,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="cf">case</span> <span class="cf">when</span> period <span class="op">=</span> <span class="dv">0</span> <span class="cf">then</span> pct_retained <span class="cf">end</span>) <span class="kw">as</span> yr0,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="cf">case</span> <span class="cf">when</span> period <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span> pct_retained <span class="cf">end</span>) <span class="kw">as</span> yr1,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="cf">case</span> <span class="cf">when</span> period <span class="op">=</span> <span class="dv">2</span> <span class="cf">then</span> pct_retained <span class="cf">end</span>) <span class="kw">as</span> yr2,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="cf">case</span> <span class="cf">when</span> period <span class="op">=</span> <span class="dv">3</span> <span class="cf">then</span> pct_retained <span class="cf">end</span>) <span class="kw">as</span> yr3,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">max</span>(<span class="cf">case</span> <span class="cf">when</span> period <span class="op">=</span> <span class="dv">4</span> <span class="cf">then</span> pct_retained <span class="cf">end</span>) <span class="kw">as</span> yr4</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> retained_data</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>1 records</caption>
<thead>
<tr class="header">
<th style="text-align: right;">cohort_size</th>
<th style="text-align: right;">yr0</th>
<th style="text-align: right;">yr1</th>
<th style="text-align: right;">yr2</th>
<th style="text-align: right;">yr3</th>
<th style="text-align: right;">yr4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.2875859</td>
<td style="text-align: right;">0.2891037</td>
<td style="text-align: right;">0.1462694</td>
<td style="text-align: right;">0.2564307</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>retained_data <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(period, pct_retained) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(period <span class="sc">&lt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(period) <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> period, </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_prefix =</span> <span class="st">"yr"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> pct_retained) <span class="sc">%&gt;%</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">yr0</th>
<th style="text-align: right;">yr1</th>
<th style="text-align: right;">yr2</th>
<th style="text-align: right;">yr3</th>
<th style="text-align: right;">yr4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.2875859</td>
<td style="text-align: right;">0.2891037</td>
<td style="text-align: right;">0.1462694</td>
<td style="text-align: right;">0.2564307</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="adjusting-time-series-to-increase-retention-accuracy" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="adjusting-time-series-to-increase-retention-accuracy"><span class="header-section-number">4.3</span> Adjusting Time Series to Increase Retention Accuracy</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>date_dim <span class="ot">&lt;-</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">'1770-12-31'</span>), </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">as.Date</span>(<span class="st">'2020-12-31'</span>), </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="st">"1 year"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy_to</span>(db, ., <span class="at">overwrite =</span> <span class="cn">TRUE</span>, <span class="at">name =</span> <span class="st">"date_dim"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>first_terms <span class="kw">AS</span> (</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> id_bioguide, <span class="fu">min</span>(term_start) <span class="kw">AS</span> first_term</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> legislators_terms </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> a.id_bioguide, a.first_term, b.term_start, b.term_end,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  c.<span class="dt">date</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  date_part(<span class="st">'year'</span>, age(c.<span class="dt">date</span>, a.first_term)) <span class="kw">AS</span> period</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> first_terms a</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> legislators_terms b <span class="kw">USING</span> (id_bioguide)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> date_dim c <span class="kw">ON</span> c.<span class="dt">date</span> <span class="kw">BETWEEN</span> b.term_start <span class="kw">and</span> b.term_end;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">id_bioguide</th>
<th style="text-align: left;">first_term</th>
<th style="text-align: left;">term_start</th>
<th style="text-align: left;">term_end</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">period</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">T000165</td>
<td style="text-align: left;">2020-05-19</td>
<td style="text-align: left;">2020-05-19</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">G000061</td>
<td style="text-align: left;">2020-05-19</td>
<td style="text-align: left;">2020-05-19</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">M000687</td>
<td style="text-align: left;">1987-01-06</td>
<td style="text-align: left;">2020-05-05</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">33</td>
</tr>
<tr class="even">
<td style="text-align: left;">M001210</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">M001210</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2019-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">B001311</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">B001311</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2019-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">K000395</td>
<td style="text-align: left;">2019-06-03</td>
<td style="text-align: left;">2019-06-03</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">K000395</td>
<td style="text-align: left;">2019-06-03</td>
<td style="text-align: left;">2019-06-03</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2019-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">S001217</td>
<td style="text-align: left;">2019-01-08</td>
<td style="text-align: left;">2019-01-08</td>
<td style="text-align: left;">2025-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>year_ends <span class="ot">&lt;-</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">'1770-12-31'</span>), </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">as.Date</span>(<span class="st">'2030-12-31'</span>), </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"1 year"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy_to</span>(db, ., <span class="at">names =</span> <span class="st">"year_ends"</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>cohorts <span class="ot">&lt;-</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  first_terms <span class="sc">%&gt;%</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(legislators_terms, <span class="at">by =</span> <span class="fu">join_by</span>(id_bioguide)) <span class="sc">%&gt;%</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(year_ends, </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">join_by</span>(<span class="fu">between</span>(y<span class="sc">$</span>date, x<span class="sc">$</span>term_start, x<span class="sc">$</span>term_end))) <span class="sc">%&gt;%</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">period =</span> <span class="fu">date_part</span>(<span class="st">'year'</span>, <span class="fu">age</span>(date, first_term))) <span class="sc">%&gt;%</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id_bioguide, first_term, term_start, term_end, date, period) </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>cohorts <span class="sc">%&gt;%</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">id_bioguide</th>
<th style="text-align: left;">first_term</th>
<th style="text-align: left;">term_start</th>
<th style="text-align: left;">term_end</th>
<th style="text-align: left;">date</th>
<th style="text-align: right;">period</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">T000165</td>
<td style="text-align: left;">2020-05-19</td>
<td style="text-align: left;">2020-05-19</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">G000061</td>
<td style="text-align: left;">2020-05-19</td>
<td style="text-align: left;">2020-05-19</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">M000687</td>
<td style="text-align: left;">1987-01-06</td>
<td style="text-align: left;">2020-05-05</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">33</td>
</tr>
<tr class="even">
<td style="text-align: left;">M001210</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">M001210</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2019-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">B001311</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">B001311</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2019-09-17</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2019-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">K000395</td>
<td style="text-align: left;">2019-06-03</td>
<td style="text-align: left;">2019-06-03</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2020-12-31</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">K000395</td>
<td style="text-align: left;">2019-06-03</td>
<td style="text-align: left;">2019-06-03</td>
<td style="text-align: left;">2021-01-03</td>
<td style="text-align: left;">2019-12-31</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">S001217</td>
<td style="text-align: left;">2019-01-08</td>
<td style="text-align: left;">2019-01-08</td>
<td style="text-align: left;">2025-01-03</td>
<td style="text-align: left;">2024-12-31</td>
<td style="text-align: right;">5</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>year_ends <span class="ot">&lt;-</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">date =</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"1770-12-31"</span>), </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">as.Date</span>(<span class="st">"2030-12-31"</span>), </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="st">"year"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">copy_inline</span>(db, .)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>first_terms <span class="kw">AS</span> (</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> id_bioguide, <span class="fu">min</span>(term_start) <span class="kw">AS</span> first_term</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> legislators_terms </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>year_ends <span class="kw">AS</span> (</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> generate_series:<span class="ch">:date</span> <span class="kw">as</span> <span class="dt">date</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> generate_series(<span class="st">'1770-12-31'</span>:<span class="ch">:TIMESTAMP</span>, </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'2030-12-31'</span>:<span class="ch">:TIMESTAMP</span>, </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                       <span class="dt">interval</span> <span class="st">'1 year'</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coalesce</span>(date_part(<span class="st">'year'</span>, age(c.<span class="dt">date</span>, a.first_term)), <span class="dv">0</span>) <span class="kw">AS</span> period,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(<span class="kw">DISTINCT</span> a.id_bioguide) <span class="kw">AS</span> cohort_retained</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> first_terms a</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> legislators_terms b <span class="kw">ON</span> a.id_bioguide <span class="op">=</span> b.id_bioguide </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> year_ends c <span class="kw">ON</span> c.<span class="dt">date</span> <span class="kw">BETWEEN</span> b.term_start <span class="kw">AND</span> b.term_end </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">period</th>
<th style="text-align: right;">cohort_retained</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: right;">12518</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: right;">12328</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2</td>
<td style="text-align: right;">8166</td>
</tr>
<tr class="even">
<td style="text-align: left;">3</td>
<td style="text-align: right;">8069</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: right;">5862</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: right;">5795</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: right;">4361</td>
</tr>
<tr class="even">
<td style="text-align: left;">7</td>
<td style="text-align: right;">4339</td>
</tr>
<tr class="odd">
<td style="text-align: left;">8</td>
<td style="text-align: right;">3521</td>
</tr>
<tr class="even">
<td style="text-align: left;">9</td>
<td style="text-align: right;">3485</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>first_terms <span class="kw">AS</span> (</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> id_bioguide, <span class="fu">min</span>(term_start) <span class="kw">as</span> first_term</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> legislators_terms </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>cohorts_retained <span class="kw">AS</span> (        </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">coalesce</span>(date_part(<span class="st">'year'</span>, age(c.<span class="dt">date</span>,a.first_term)),<span class="dv">0</span>) <span class="kw">AS</span> period,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(<span class="kw">distinct</span> a.id_bioguide) <span class="kw">as</span> cohort_retained</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> first_terms a</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">JOIN</span> legislators_terms b <span class="kw">USING</span> (id_bioguide)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">LEFT</span> <span class="kw">JOIN</span> date_dim c <span class="kw">ON</span> c.<span class="dt">date</span> <span class="kw">BETWEEN</span> b.term_start <span class="kw">AND</span> b.term_end</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> period,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">first_value</span>(cohort_retained) <span class="kw">OVER</span> w <span class="kw">AS</span> cohort_size,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  cohort_retained,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  cohort_retained <span class="op">*</span> <span class="fl">1.0</span><span class="op">/</span><span class="fu">first_value</span>(cohort_retained) <span class="kw">over</span> w <span class="kw">as</span> pct_retained</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> cohorts_retained</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>WINDOW w <span class="kw">AS</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> period);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">period</th>
<th style="text-align: right;">cohort_size</th>
<th style="text-align: right;">cohort_retained</th>
<th style="text-align: right;">pct_retained</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">12328</td>
<td style="text-align: right;">0.9848219</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">8162</td>
<td style="text-align: right;">0.6520211</td>
</tr>
<tr class="even">
<td style="text-align: left;">3</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">8065</td>
<td style="text-align: right;">0.6442722</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">5853</td>
<td style="text-align: right;">0.4675667</td>
</tr>
<tr class="even">
<td style="text-align: left;">5</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">5786</td>
<td style="text-align: right;">0.4622144</td>
</tr>
<tr class="odd">
<td style="text-align: left;">6</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">4360</td>
<td style="text-align: right;">0.3482985</td>
</tr>
<tr class="even">
<td style="text-align: left;">7</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">4338</td>
<td style="text-align: right;">0.3465410</td>
</tr>
<tr class="odd">
<td style="text-align: left;">8</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">3513</td>
<td style="text-align: right;">0.2806359</td>
</tr>
<tr class="even">
<td style="text-align: left;">9</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">3476</td>
<td style="text-align: right;">0.2776801</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>cohorts_retained <span class="ot">&lt;-</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  cohorts <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">period =</span> <span class="fu">coalesce</span>(<span class="fu">date_part</span>(<span class="st">'year'</span>, <span class="fu">age</span>(date, first_term)), <span class="dv">0</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(period, id_bioguide) <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(period) <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">cohort_retained =</span> <span class="fu">n</span>()) </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>pct_retained <span class="ot">&lt;-</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  cohorts_retained <span class="sc">%&gt;%</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(period) <span class="sc">%&gt;%</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cohort_size =</span> <span class="fu">first</span>(cohort_retained),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">cohort_retained =</span> <span class="fu">as.double</span>(cohort_retained),</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">pct_retained =</span> cohort_retained<span class="sc">/</span>cohort_size) </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>pct_retained <span class="sc">%&gt;%</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(period) <span class="sc">%&gt;%</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">period</th>
<th style="text-align: right;">cohort_retained</th>
<th style="text-align: right;">cohort_size</th>
<th style="text-align: right;">pct_retained</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">1.0000000</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">12328</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">0.9848219</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">8166</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">0.6523406</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">8069</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">0.6445918</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: right;">5862</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">0.4682857</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">5795</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">0.4629334</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: right;">4361</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">0.3483783</td>
</tr>
<tr class="even">
<td style="text-align: right;">7</td>
<td style="text-align: right;">4339</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">0.3466209</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8</td>
<td style="text-align: right;">3521</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">0.2812750</td>
</tr>
<tr class="even">
<td style="text-align: right;">9</td>
<td style="text-align: right;">3485</td>
<td style="text-align: right;">12518</td>
<td style="text-align: right;">0.2783991</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pct_retained <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> period, <span class="at">y =</span> pct_retained)) <span class="sc">+</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter_4_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>first_terms <span class="kw">AS</span> (</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> id_bioguide, <span class="fu">min</span>(term_start) <span class="kw">AS</span> first_term</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> legislators_terms </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> id_bioguide, a.first_term, b.term_start,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span> <span class="cf">WHEN</span> b.term_type <span class="op">=</span> <span class="st">'rep'</span> <span class="cf">THEN</span> b.term_start <span class="op">+</span> <span class="dt">interval</span> <span class="st">'2 years'</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>       <span class="cf">WHEN</span> b.term_type <span class="op">=</span> <span class="st">'sen'</span> <span class="cf">THEN</span> b.term_start <span class="op">+</span> <span class="dt">interval</span> <span class="st">'6 years'</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> term_end</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> first_terms a</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> legislators_terms b <span class="kw">USING</span> (id_bioguide);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: left;">id_bioguide</th>
<th style="text-align: left;">first_term</th>
<th style="text-align: left;">term_start</th>
<th style="text-align: left;">term_end</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">F000062</td>
<td style="text-align: left;">1992-11-10</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2025-01-03</td>
</tr>
<tr class="even">
<td style="text-align: left;">T000464</td>
<td style="text-align: left;">2007-01-04</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2025-01-03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A000360</td>
<td style="text-align: left;">2003-01-07</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2021-01-06</td>
</tr>
<tr class="even">
<td style="text-align: left;">G000359</td>
<td style="text-align: left;">1995-01-04</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2021-01-06</td>
</tr>
<tr class="odd">
<td style="text-align: left;">R000307</td>
<td style="text-align: left;">1981-01-05</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2021-01-06</td>
</tr>
<tr class="even">
<td style="text-align: left;">A000055</td>
<td style="text-align: left;">1997-01-07</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2021-01-03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">T000474</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2021-01-03</td>
</tr>
<tr class="even">
<td style="text-align: left;">C001047</td>
<td style="text-align: left;">2001-01-03</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2021-01-06</td>
</tr>
<tr class="odd">
<td style="text-align: left;">H001052</td>
<td style="text-align: left;">2011-01-05</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2021-01-03</td>
</tr>
<tr class="even">
<td style="text-align: left;">H001038</td>
<td style="text-align: left;">2005-01-04</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2021-01-03</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>first_terms <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(legislators_terms, <span class="at">by =</span> <span class="fu">join_by</span>(id_bioguide)) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">term_end =</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">case_when</span>(term_type <span class="sc">==</span> <span class="st">'rep'</span> <span class="sc">~</span> term_start <span class="sc">+</span> <span class="fu">years</span>(<span class="dv">2</span>),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                     term_type <span class="sc">==</span> <span class="st">'sen'</span> <span class="sc">~</span> term_start <span class="sc">+</span> <span class="fu">years</span>(<span class="dv">6</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id_bioguide, first_term, term_start, term_end)  <span class="sc">%&gt;%</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">id_bioguide</th>
<th style="text-align: left;">first_term</th>
<th style="text-align: left;">term_start</th>
<th style="text-align: left;">term_end</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">F000062</td>
<td style="text-align: left;">1992-11-10</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2025-01-03</td>
</tr>
<tr class="even">
<td style="text-align: left;">T000464</td>
<td style="text-align: left;">2007-01-04</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2025-01-03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">A000360</td>
<td style="text-align: left;">2003-01-07</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2021-01-06</td>
</tr>
<tr class="even">
<td style="text-align: left;">G000359</td>
<td style="text-align: left;">1995-01-04</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2021-01-06</td>
</tr>
<tr class="odd">
<td style="text-align: left;">R000307</td>
<td style="text-align: left;">1981-01-05</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2021-01-06</td>
</tr>
<tr class="even">
<td style="text-align: left;">A000055</td>
<td style="text-align: left;">1997-01-07</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2021-01-03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">T000474</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2021-01-03</td>
</tr>
<tr class="even">
<td style="text-align: left;">C001047</td>
<td style="text-align: left;">2001-01-03</td>
<td style="text-align: left;">2015-01-06</td>
<td style="text-align: left;">2021-01-06</td>
</tr>
<tr class="odd">
<td style="text-align: left;">H001052</td>
<td style="text-align: left;">2011-01-05</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2021-01-03</td>
</tr>
<tr class="even">
<td style="text-align: left;">H001038</td>
<td style="text-align: left;">2005-01-04</td>
<td style="text-align: left;">2019-01-03</td>
<td style="text-align: left;">2021-01-03</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-connection="db">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> first_terms <span class="kw">AS</span> (</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> id_bioguide, <span class="fu">min</span>(term_start) <span class="kw">AS</span> first_term</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> legislators_terms </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>first_centuries <span class="kw">AS</span> (</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    date_part(<span class="st">'century'</span>, a.first_term) <span class="kw">AS</span> first_century,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coalesce</span>(date_part(<span class="st">'year'</span>, age(c.<span class="dt">date</span>, a.first_term)), <span class="dv">0</span>) <span class="kw">AS</span> period,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> a.id_bioguide) <span class="kw">AS</span> cohort_retained</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> first_terms <span class="kw">AS</span> a</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INNER</span> <span class="kw">JOIN</span> legislators_terms b </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">USING</span> (id_bioguide)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">JOIN</span> date_dim c </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> c.<span class="dt">date</span> <span class="kw">BETWEEN</span> b.term_start <span class="kw">AND</span> b.term_end </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> first_century, period,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">first_value</span>(cohort_retained) <span class="kw">OVER</span> w <span class="kw">AS</span> cohort_size,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  cohort_retained,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  cohort_retained <span class="op">*</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="fu">first_value</span>(cohort_retained) <span class="kw">OVER</span> w <span class="kw">AS</span> prop_retained</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> first_centuries <span class="kw">AS</span> aa</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>WINDOW w <span class="kw">AS</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> first_century <span class="kw">ORDER</span> <span class="kw">BY</span> period)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="knitsql-table">
<table class="table table-sm table-striped">
<caption>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th style="text-align: right;">first_century</th>
<th style="text-align: right;">period</th>
<th style="text-align: right;">cohort_size</th>
<th style="text-align: right;">cohort_retained</th>
<th style="text-align: right;">prop_retained</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">18</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">1.0000000</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">360</td>
<td style="text-align: right;">0.9782609</td>
</tr>
<tr class="odd">
<td style="text-align: right;">18</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">242</td>
<td style="text-align: right;">0.6576087</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">233</td>
<td style="text-align: right;">0.6331522</td>
</tr>
<tr class="odd">
<td style="text-align: right;">18</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">149</td>
<td style="text-align: right;">0.4048913</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">144</td>
<td style="text-align: right;">0.3913043</td>
</tr>
<tr class="odd">
<td style="text-align: right;">18</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">99</td>
<td style="text-align: right;">0.2690217</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">0.2744565</td>
</tr>
<tr class="odd">
<td style="text-align: right;">18</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">0.1983696</td>
</tr>
<tr class="even">
<td style="text-align: right;">18</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">368</td>
<td style="text-align: right;">70</td>
<td style="text-align: right;">0.1902174</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(db, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-tanimura2021sql" class="csl-entry" role="doc-biblioentry">
Tanimura, C. 2021. <em>SQL for Data Analysis</em>. O’Reilly Media. <a href="https://books.google.com.au/books?id=ojhCEAAAQBAJ">https://books.google.com.au/books?id=ojhCEAAAQBAJ</a>.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>In writing this sentence, I am still working through the chapter.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>See <a href="https://www.aihw.gov.au/reports/life-expectancy-death/deaths-in-australia/contents/life-expectancy">here</a> for the source for these data.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>I made no effort to research how they are constructed because (1) I am lazy and (2) my imagined version is probably better for my current purposes.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>There are some details I’m glossing over here, such as the fact that there will be some <span class="math inline">\(j\)</span> where the cumulative survival probability is just above one-half, but where that for <span class="math inline">\(j + 1\)</span> is just below one-half, so some interpolation will be required.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapter_3.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Time Series Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter_5.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Text Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>