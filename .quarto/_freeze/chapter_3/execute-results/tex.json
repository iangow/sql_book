{
  "hash": "c29e2aff6a1ecc8cd9ef8380edae1f16",
  "result": {
    "markdown": "# Time Series Analysis\n\n## Date, Datetime, and Time Manipulations\n\n\n\n\n\n\n\n@tanimura2021sql points out that often \"timestamps in the database are not encoded with the time zone, and you will need to consult with the source or developer to figure out how your data was stored.\"\nWhen pushing data to a PostgreSQL database, I use the `timestamp with time zone` type as much as possible.\n\n@tanimura2021sql provides the following example, which is interesting because the west coast of the United States would not be on the PST time zone at that time of year.\nInstead, it would be on PDT.\n\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT '2020-09-01 00:00:00 -0' AT TIME ZONE 'pst';\n```\n\n\n\n\nTable: 1 records\n\n|timezone            |\n|:-------------------|\n|2020-08-31 16:00:00 |\n:::\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT '2020-09-01 00:00:00 -0' AT TIME ZONE 'pdt';\n```\n\n\n\n\nTable: 1 records\n\n|timezone            |\n|:-------------------|\n|2020-08-31 17:00:00 |\n:::\n\n\nI think most people barely know the difference between PST and PDT and even fewer would know the exact dates that one switches from one to the other.\nA better approach is to use a time zone that encodes information about when PDT is used and when PST is used.\nIn PostgreSQL, the table `pg_timezone_names` has information that we need.\n\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT * \nFROM pg_timezone_names\nWHERE name ~ '^US/';\n```\n\n\n\n\nTable: Displaying records 1 - 10\n\n|name              |abbrev |utc_offset |is_dst |\n|:-----------------|:------|:----------|:------|\n|US/Alaska         |AKDT   |-08:00:00  |TRUE   |\n|US/Pacific        |PDT    |-07:00:00  |TRUE   |\n|US/Eastern        |EDT    |-04:00:00  |TRUE   |\n|US/Michigan       |EDT    |-04:00:00  |TRUE   |\n|US/Arizona        |MST    |-07:00:00  |FALSE  |\n|US/Indiana-Starke |CDT    |-05:00:00  |TRUE   |\n|US/Aleutian       |HDT    |-09:00:00  |TRUE   |\n|US/Hawaii         |HST    |-10:00:00  |FALSE  |\n|US/East-Indiana   |EDT    |-04:00:00  |TRUE   |\n|US/Central        |CDT    |-05:00:00  |TRUE   |\n:::\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT * \nFROM pg_timezone_names\nWHERE abbrev IN ('PDT', 'PST') \nORDER BY name DESC\nLIMIT 5;\n```\n\n\n\n\nTable: 5 records\n\n|name             |abbrev |utc_offset |is_dst |\n|:----------------|:------|:----------|:------|\n|US/Pacific       |PDT    |-07:00:00  |TRUE   |\n|PST8PDT          |PDT    |-07:00:00  |TRUE   |\n|Mexico/BajaNorte |PDT    |-07:00:00  |TRUE   |\n|Canada/Pacific   |PDT    |-07:00:00  |TRUE   |\n|Asia/Manila      |PST    |08:00:00   |FALSE  |\n:::\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT \n    '2020-09-01 00:00:00 -0' AT TIME ZONE 'US/Pacific',\n    '2020-09-01 00:00:00 -0' AT TIME ZONE 'PDT';\n```\n\n\n\n\nTable: 1 records\n\n|timezone            |timezone..2         |\n|:-------------------|:-------------------|\n|2020-08-31 17:00:00 |2020-08-31 17:00:00 |\n:::\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT     \n    '2020-12-01 00:00:00 -0' AT TIME ZONE 'US/Pacific',\n    '2020-12-01 00:00:00 -0' AT TIME ZONE 'PST';\n```\n\n\n\n\nTable: 1 records\n\n|timezone            |timezone..2         |\n|:-------------------|:-------------------|\n|2020-11-30 16:00:00 |2020-11-30 16:00:00 |\n:::\n\n\n### Date and Timestamp Format Conversions\n\nAs discussed in @tanimura2021sql, PostgreSQL has a rich array of functions for converting dates and times and extracting such information as months and days of the week.\n\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT date_trunc('month','2020-10-04 12:33:35'::timestamp);\n```\n\n\n\n\nTable: 1 records\n\n|date_trunc |\n|:----------|\n|2020-10-01 |\n:::\n\n\nOne such function \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\na_time_df <- tbl(pg, sql(\"SELECT '2020-10-04 12:33:35'::timestamp AS a_time\"))\na_time_df %>% \n  mutate(a_trunced_time = date_trunc('month', a_time))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Source:   SQL [1 x 2]\n# Database: postgres  [iangow@/tmp:5432/iangow]\n  a_time              a_trunced_time     \n  <dttm>              <dttm>             \n1 2020-10-04 12:33:35 2020-10-01 00:00:00\n```\n:::\n\n```{.r .cell-code}\na_time_df %>% \n  mutate(a_trunced_time = date_trunc('month', a_time)) %>%\n  show_query()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT *, date_trunc('month', \"a_time\") AS \"a_trunced_time\"\nFROM (SELECT '2020-10-04 12:33:35'::timestamp AS a_time) \"q01\"\n```\n:::\n\n```{.r .cell-code}\na_time_df %>%\n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 x 1\n  a_time             \n  <dttm>             \n1 2020-10-04 12:33:35\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\na_time_df <- tbl(pg, sql(\"SELECT '2020-10-04 12:33:35 US/Pacific'::timestamp with time zone AS a_time\"))\n\na_time_df %>% \n  mutate(a_trunced_time = date_trunc('month', a_time)) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Source:   SQL [1 x 2]\n# Database: postgres  [iangow@/tmp:5432/iangow]\n  a_time              a_trunced_time     \n  <dttm>              <dttm>             \n1 2020-10-04 19:33:35 2020-10-01 00:00:00\n```\n:::\n\n```{.r .cell-code}\na_time_df %>% \n  mutate(a_trunced_time = date_trunc('month', a_time)) %>%\n  show_query()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT *, date_trunc('month', \"a_time\") AS \"a_trunced_time\"\nFROM (SELECT '2020-10-04 12:33:35 US/Pacific'::timestamp with time zone AS a_time) \"q01\"\n```\n:::\n\n```{.r .cell-code}\na_time_df %>%\n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 x 1\n  a_time             \n  <dttm>             \n1 2020-10-04 19:33:35\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\na_time_df %>%\n  mutate(new_time = a_time + sql(\"interval '3 hours'\")) %>%\n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 x 2\n  a_time              new_time           \n  <dttm>              <dttm>             \n1 2020-10-04 19:33:35 2020-10-04 22:33:35\n```\n:::\n:::\n\n\n## The Retail Sales Data Set\n\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT sales_month, sales\nFROM retail_sales\nWHERE kind_of_business = 'Retail and food services sales, total'\nORDER BY 1\n```\n\n\n\n\nTable: Displaying records 1 - 10\n\n|sales_month |  sales|\n|:-----------|------:|\n|1992-01-01  | 146376|\n|1992-02-01  | 147079|\n|1992-03-01  | 159336|\n|1992-04-01  | 163669|\n|1992-05-01  | 170068|\n|1992-06-01  | 168663|\n|1992-07-01  | 169890|\n|1992-08-01  | 170364|\n|1992-09-01  | 164617|\n|1992-10-01  | 173655|\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales <- tbl(pg, \"retail_sales\")\nretail_sales %>%\n  filter(kind_of_business == 'Retail and food services sales, total') %>%\n  select(sales_month, sales) %>%\n  arrange(sales_month) %>%\n  ggplot(aes(x = sales_month, y = sales)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-13-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT date_part('year',sales_month) as sales_year,\n    sum(sales) as sales\nFROM retail_sales\nWHERE kind_of_business = 'Retail and food services sales, total'\nGROUP BY 1\n;\n```\n\n\n\n\nTable: Displaying records 1 - 10\n\n| sales_year|   sales|\n|----------:|-------:|\n|       2007| 4439733|\n|       2005| 4085746|\n|       1992| 2014102|\n|       2011| 4598302|\n|       2014| 5215656|\n|       2006| 4294359|\n|       2010| 4284968|\n|       2001| 3378906|\n|       2019| 6218002|\n|       2018| 6001623|\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business == 'Retail and food services sales, total') %>%\n  mutate(sales_year = date_part('year', sales_month)) %>%\n  group_by(sales_year) %>%\n  summarize(sales = sum(sales, na.rm = TRUE)) %>%\n  arrange(sales_year) %>%\n  ggplot(aes(x = sales_year, y = sales)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-15-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT date_part('year',sales_month) as sales_year, \n  kind_of_business, sum(sales) as sales\nFROM retail_sales\nWHERE kind_of_business IN \n          ('Book stores',\n           'Sporting goods stores',\n           'Hobby, toy, and game stores')\nGROUP BY 1,2\nORDER BY 1;\n```\n\n\n\n\nTable: Displaying records 1 - 10\n\n| sales_year|kind_of_business            | sales|\n|----------:|:---------------------------|-----:|\n|       1992|Sporting goods stores       | 15583|\n|       1992|Hobby, toy, and game stores | 11251|\n|       1992|Book stores                 |  8327|\n|       1993|Hobby, toy, and game stores | 11651|\n|       1993|Sporting goods stores       | 16791|\n|       1993|Book stores                 |  9108|\n|       1994|Sporting goods stores       | 18825|\n|       1994|Book stores                 | 10107|\n|       1994|Hobby, toy, and game stores | 12850|\n|       1995|Hobby, toy, and game stores | 13714|\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c('Book stores',\n             'Sporting goods stores',\n             'Hobby, toy, and game stores')) %>%\n  mutate(sales_year = date_part('year', sales_month)) %>%\n  group_by(sales_year, kind_of_business) %>%\n  summarize(sales = sum(sales, na.rm = TRUE), .groups = \"drop\") %>%\n  arrange(sales_year) %>%\n  ggplot(aes(x = sales_year, y = sales, color = kind_of_business)) +\n  geom_line() +\n  theme(legend.position = \"top\")\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-17-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT sales_month, kind_of_business, sales\nFROM retail_sales\nWHERE kind_of_business IN ('Men''s clothing stores','Women''s clothing stores')\nORDER BY 1,2;\n```\n\n\n\n\nTable: Displaying records 1 - 10\n\n|sales_month |kind_of_business        | sales|\n|:-----------|:-----------------------|-----:|\n|1992-01-01  |Men's clothing stores   |   701|\n|1992-01-01  |Women's clothing stores |  1873|\n|1992-02-01  |Men's clothing stores   |   658|\n|1992-02-01  |Women's clothing stores |  1991|\n|1992-03-01  |Men's clothing stores   |   731|\n|1992-03-01  |Women's clothing stores |  2403|\n|1992-04-01  |Men's clothing stores   |   816|\n|1992-04-01  |Women's clothing stores |  2665|\n|1992-05-01  |Men's clothing stores   |   856|\n|1992-05-01  |Women's clothing stores |  2752|\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business %in% c(\"Men's clothing stores\",\n                                 \"Women's clothing stores\")) %>%\n  select(sales_month, kind_of_business, sales) %>%\n  arrange(sales_month) %>%\n  ggplot(aes(x = sales_month, y = sales, color = kind_of_business)) +\n  geom_line() +\n  theme(legend.position = \"top\")\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-19-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT date_part('year',sales_month) as sales_year,\n  kind_of_business, sum(sales) as sales\nFROM retail_sales\nWHERE kind_of_business IN \n        ('Men''s clothing stores',\n        'Women''s clothing stores')\nGROUP BY 1, 2\nORDER BY 1, 2;\n```\n\n\n\n\nTable: Displaying records 1 - 10\n\n| sales_year|kind_of_business        | sales|\n|----------:|:-----------------------|-----:|\n|       1992|Men's clothing stores   | 10179|\n|       1992|Women's clothing stores | 31815|\n|       1993|Men's clothing stores   |  9962|\n|       1993|Women's clothing stores | 32350|\n|       1994|Men's clothing stores   | 10032|\n|       1994|Women's clothing stores | 30585|\n|       1995|Men's clothing stores   |  9315|\n|       1995|Women's clothing stores | 28696|\n|       1996|Men's clothing stores   |  9546|\n|       1996|Women's clothing stores | 28238|\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  mutate(sales_year = date_part('year', sales_month)) %>%\n  group_by(sales_year, kind_of_business) %>%\n  summarize(sales = sum(sales, na.rm = TRUE), .groups = \"drop\") %>%\n  arrange(sales_year) %>%\n  ggplot(aes(x = sales_year, y = sales, color = kind_of_business)) +\n  geom_line() +\n  theme(legend.position = \"top\")\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-21-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT date_part('year', sales_month) AS sales_year,\n  sum(CASE WHEN kind_of_business = 'Women''s clothing stores' \n          then sales \n          END) AS womens_sales,\n  sum(CASE WHEN kind_of_business = 'Men''s clothing stores' \n          then sales \n          END) AS mens_sales\nFROM retail_sales\nWHERE kind_of_business IN \n   ('Men''s clothing stores',\n    'Women''s clothing stores')\nGROUP BY 1\nORDER BY 1;\n```\n\n\n\n\nTable: Displaying records 1 - 10\n\n|sales_year | womens_sales| mens_sales|\n|:----------|------------:|----------:|\n|1992       |        31815|      10179|\n|1993       |        32350|       9962|\n|1994       |        30585|      10032|\n|1995       |        28696|       9315|\n|1996       |        28238|       9546|\n|1997       |        27822|      10069|\n|1998       |        28332|      10196|\n|1999       |        29549|       9667|\n|2000       |        31447|       9507|\n|2001       |        31453|       8625|\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npivoted_sales <-\n  retail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  mutate(kind_of_business = if_else(kind_of_business == \"Women's clothing stores\",\n                                    \"womens\", \"mens\"),\n         sales_year = date_part('year', sales_month)) %>%\n  group_by(sales_year, kind_of_business) %>%\n  summarize(sales = sum(sales, na.rm = TRUE), .groups = \"drop\") %>%\n  pivot_wider(id_cols = \"sales_year\",\n              names_from = \"kind_of_business\",\n              names_glue = \"{kind_of_business}_{.value}\",\n              values_from = \"sales\")  \n\npivoted_sales %>%\n  show_query()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT\n  \"sales_year\",\n  MAX(CASE WHEN (\"kind_of_business\" = 'mens') THEN \"sales\" END) AS \"mens_sales\",\n  MAX(CASE WHEN (\"kind_of_business\" = 'womens') THEN \"sales\" END) AS \"womens_sales\"\nFROM (\n  SELECT \"sales_year\", \"kind_of_business\", SUM(\"sales\") AS \"sales\"\n  FROM (\n    SELECT\n      \"sales_month\",\n      \"naics_code\",\n      CASE WHEN (\"kind_of_business\" = 'Women''s clothing stores') THEN 'womens' WHEN NOT (\"kind_of_business\" = 'Women''s clothing stores') THEN 'mens' END AS \"kind_of_business\",\n      \"reason_for_null\",\n      \"sales\",\n      date_part('year', \"sales_month\") AS \"sales_year\"\n    FROM \"retail_sales\"\n    WHERE (\"kind_of_business\" IN ('Men''s clothing stores', 'Women''s clothing stores'))\n  ) \"q01\"\n  GROUP BY \"sales_year\", \"kind_of_business\"\n) \"q02\"\nGROUP BY \"sales_year\"\n```\n:::\n\n```{.r .cell-code}\npivoted_sales %>%\n  arrange(sales_year) %>%\n  collect(n = 10) %>%\n  knitr::kable()\n```\n\n::: {.cell-output-display}\n| sales_year| mens_sales| womens_sales|\n|----------:|----------:|------------:|\n|       1992|      10179|        31815|\n|       1993|       9962|        32350|\n|       1994|      10032|        30585|\n|       1995|       9315|        28696|\n|       1996|       9546|        28238|\n|       1997|      10069|        27822|\n|       1998|      10196|        28332|\n|       1999|       9667|        29549|\n|       2000|       9507|        31447|\n|       2001|       8625|        31453|\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npivoted_sales %>%\n  filter(sales_year <= 2019) %>%\n  group_by(sales_year) %>%\n  mutate(womens_minus_mens = womens_sales - mens_sales,\n         mens_minus_womens = mens_sales - womens_sales) %>%\n  select(sales_year, womens_minus_mens, mens_minus_womens) %>%\n  arrange(sales_year) %>%\n  ggplot(aes(y = womens_minus_mens, x = sales_year)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-24-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npivoted_sales %>%\n  filter(sales_year <= 2019) %>%\n  group_by(sales_year) %>%\n  mutate(womens_times_of_mens = womens_sales / mens_sales) %>%\n  arrange(sales_year) %>%\n  ggplot(aes(y = womens_times_of_mens, x = sales_year)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-25-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npivoted_sales %>%\n  filter(sales_year <= 2019) %>%\n  group_by(sales_year) %>%\n  mutate(womens_pct_of_mens = (womens_sales / mens_sales - 1) * 100) %>%\n  arrange(sales_year) %>%\n  ggplot(aes(y = womens_pct_of_mens, x = sales_year)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-26-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  group_by(sales_month) %>%\n  mutate(total_sales = sum(sales)) %>%\n  ungroup() %>%\n  mutate(pct_total_sales = sales * 100 / total_sales) %>%\n  select(sales_month, kind_of_business, pct_total_sales) %>%\n  collect(n = 3)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Missing values are always removed in SQL aggregation functions.\nUse `na.rm = TRUE` to silence this warning\nThis warning is displayed once every 8 hours.\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 x 3\n  sales_month kind_of_business        pct_total_sales\n  <date>      <chr>                             <dbl>\n1 1992-01-01  Women's clothing stores            72.8\n2 1992-01-01  Men's clothing stores              27.2\n3 1992-02-01  Men's clothing stores              24.8\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  group_by(sales_month) %>%\n  mutate(total_sales = sum(sales)) %>%\n  ungroup() %>%\n  mutate(pct_total_sales = sales * 100 / total_sales) %>%\n  show_query()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<SQL>\nSELECT *, (\"sales\" * 100.0) / \"total_sales\" AS \"pct_total_sales\"\nFROM (\n  SELECT *, SUM(\"sales\") OVER (PARTITION BY \"sales_month\") AS \"total_sales\"\n  FROM \"retail_sales\"\n  WHERE (\"kind_of_business\" IN ('Men''s clothing stores', 'Women''s clothing stores'))\n) \"q01\"\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  group_by(sales_month) %>%\n  mutate(total_sales = sum(sales)) %>%\n  ungroup() %>%\n  mutate(pct_total_sales = sales * 100 / total_sales) %>%\n  ggplot(aes(y = pct_total_sales, x = sales_month, color = kind_of_business)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-29-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business == \"Women's clothing stores\") %>%\n  mutate(sales_year = date_part('year',sales_month)) %>%\n  group_by(sales_year) %>%\n  summarize(sales = sum(sales, na.rm = TRUE)) %>%\n  ungroup() %>%\n  window_order(sales_year) %>%\n  mutate(index_sales = first(sales),\n         pct_from_index = (sales/index_sales - 1) * 100)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Source:     SQL [?? x 4]\n# Database:   postgres  [iangow@/tmp:5432/iangow]\n# Ordered by: sales_year\n   sales_year sales index_sales pct_from_index\n        <dbl> <dbl>       <dbl>          <dbl>\n 1       1992 31815       31815           0   \n 2       1993 32350       31815           1.68\n 3       1994 30585       31815          -3.87\n 4       1995 28696       31815          -9.80\n 5       1996 28238       31815         -11.2 \n 6       1997 27822       31815         -12.6 \n 7       1998 28332       31815         -10.9 \n 8       1999 29549       31815          -7.12\n 9       2000 31447       31815          -1.16\n10       2001 31453       31815          -1.14\n# ... with more rows\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business %in% c(\"Women's clothing stores\",\n                                 \"Men's clothing stores\"),\n         sales_month <= '2019-12-31') %>%\n  mutate(sales_year = date_part('year',sales_month)) %>%\n  group_by(kind_of_business, sales_year) %>%\n  summarize(sales = sum(sales, na.rm = TRUE), .groups = \"drop\") %>%\n  group_by(kind_of_business) %>%\n  window_order(sales_year) %>%\n  mutate(index_sales = first(sales),\n         pct_from_index = (sales/index_sales - 1) * 100) %>%\n  ungroup() %>%\n  ggplot(aes(y = pct_from_index, x = sales_year, color = kind_of_business)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](chapter_3_files/figure-pdf/unnamed-chunk-31-1.pdf){fig-pos='H'}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nretail_sales %>%\n  filter(kind_of_business == \"Women's clothing stores\") %>%\n  window_order(sales_month) %>%\n  window_frame(-11, 0) %>%\n  mutate(moving_avg = mean(sales, na.rm = TRUE),\n         records_count = n()) %>%\n  select(sales_month, moving_avg, records_count) %>%\n  collect(n = 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10 x 3\n   sales_month moving_avg records_count\n   <date>           <dbl>         <int>\n 1 1992-01-01       1873              1\n 2 1992-02-01       1932              2\n 3 1992-03-01       2089              3\n 4 1992-04-01       2233              4\n 5 1992-05-01       2337.             5\n 6 1992-06-01       2351.             6\n 7 1992-07-01       2354.             7\n 8 1992-08-01       2392.             8\n 9 1992-09-01       2411.             9\n10 1992-10-01       2445.            10\n```\n:::\n:::",
    "supporting": [
      "chapter_3_files/figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}