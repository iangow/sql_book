{"title":"Preparing Data for Analysis","markdown":{"headingText":"Preparing Data for Analysis","containsRefs":false,"markdown":"\nChapter 2 of @tanimura2021sql provides a good foundation discussion of issues related to preparing data for analysis.\nWhile the discussion is couched in terms of SQL, in reality the issues are not specific to SQL or databases.\nFor this reason, I recommend that you read the chapter.\n\nWhile Chapter 2 of @tanimura2021sql contains many code snippets, few of these seem to be intended for users to run (in part because they assume a database set-up that users would not have).\nFor this reason, I do not attempt to provide `dplyr` equivalents to the code there except for a couple of exceptions that I discuss below.\n\n## Missing data\n\n```{r}\n#| message: false\nlibrary(tidyverse)\nlibrary(DBI)\n```\n\n```{r}\npg <- dbConnect(RPostgres::Postgres())\n\ndates_sql <-\n   \"SELECT * \n    FROM generate_series('2000-01-01'::timestamp,'2030-12-31', '1 day')\"\n\ndates <- \n  tbl(pg, sql(dates_sql)) %>%\n  rename(date = generate_series)\n\ndates_processed <-\n  dates %>%\n  mutate(date_key = as.integer(to_char(date, 'yyyymmdd')),\n         day_of_month = as.integer(date_part('day',date)),\n         day_of_year = as.integer(date_part('doy', date)),\n         day_of_week = as.integer(date_part('dow', date)),\n         day_name  = trim(to_char(date, 'Day')),\n         day_short_name = trim(to_char(date, 'Dy')),\n         week_number = as.integer(date_part('week', date)),\n         week_of_month = as.integer(to_char(date,'W')),\n         week = as.Date(date_trunc('week', date)),\n         month_number = as.integer(date_part('month',date)),\n         month_name = trim(to_char(date, 'Month')),\n         month_short_name = trim(to_char(date, 'Mon')),\n         first_day_of_month = as.Date(date_trunc('month', date)),\n         last_day_of_month = as.Date(date_trunc('month', date) +\n                                       sql(\"interval '1 month' -\n                                            interval '1 day'\")),\n         quarter_number = as.integer(date_part('quarter', date)),\n         quarter_name = trim('Q' %||% as.integer(date_part('quarter', date))),\n         first_day_of_quarter = as.Date(date_trunc('quarter', date)),\n         last_day_of_quarter = as.Date(date_trunc('quarter', date) + \n                                         sql(\"interval '3 months' -\n                                              interval '1 day'\")),\n         year = as.integer(date_part('year', date)),\n         decade = as.integer(date_part('decade', date)) * 10,\n         century = as.integer(date_part('century', date)))\n\ndates_processed %>%\n  collect(n = 10)\n\ndates_processed %>%\n  show_query()\n```\n\n\n```{sql}\n#| eval: false\n\n\n\n\n\n\n```\n\n\n\n```{r}\nctry_pops <-\n  tribble(\n  ~country, ~year_1980,  ~year_1990, ~year_2000, ~year_2010,\n  \"Canada\", 24593, 27791, 31100, 34207,\n  \"Mexico\", 68347, 84634, 99775, 114061,\n  \"United States\", 227225, 249623, 282162, 309326\n)\n\nctry_pops %>%\n  pivot_longer(cols = -country, \n               names_to = \"year\",\n               names_prefix = \"year_\",\n               values_ptypes = integer(),\n               values_to = \"population\")\n```\n\n```{r}\n\nctry_pops_db <- copy_to(pg, ctry_pops)\n```\n\n```{r}\nctry_pops_db %>%\n  pivot_longer(cols = -country, \n               names_to = \"year\",\n               names_prefix = \"year_\",\n               values_to = \"population\") %>%\n  show_query()\n```"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"chapter_2.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.269","bibliography":["references.bib"],"editor":"visual","theme":"cosmo"},"extensions":{"book":{"multiFile":true}}},"pdf":{"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"chapter_2.pdf"},"language":{},"metadata":{"block-headings":true,"bibliography":["references.bib"],"editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{}}}}}