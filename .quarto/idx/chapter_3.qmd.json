{"title":"Time Series Analysis","markdown":{"headingText":"Time Series Analysis","containsRefs":false,"markdown":"\n## Date, Datetime, and Time Manipulations\n\n```{r}\n#| include: false\nlibrary(DBI)\nlibrary(tidyverse)\nlibrary(dbplyr)\npg <- dbConnect(RPostgres::Postgres(), bigint = \"integer\")\n```\n\n@tanimura2021sql points out that often \"timestamps in the database are not encoded with the time zone, and you will need to consult with the source or developer to figure out how your data was stored.\"\nWhen pushing data to a PostgreSQL database, I use the `timestamp with time zone` type as much as possible.\n\n@tanimura2021sql provides the following example, which is interesting because the west coast of the United States would not be on the PST time zone at that time of year.\nInstead, it would be on PDT.\n\n```{sql, connection=pg}\nSELECT '2020-09-01 00:00:00 -0' AT TIME ZONE 'pst';\n```\n```{sql, connection=pg}\nSELECT '2020-09-01 00:00:00 -0' AT TIME ZONE 'pdt';\n```\nI think most people barely know the difference between PST and PDT and even fewer would know the exact dates that one switches from one to the other.\nA better approach is to use a time zone that encodes information about when PDT is used and when PST is used.\nIn PostgreSQL, the table `pg_timezone_names` has information that we need.\n\n```{sql, connection=pg}\nSELECT * \nFROM pg_timezone_names\nWHERE name ~ '^US/';\n```\n```{sql, connection=pg}\nSELECT * \nFROM pg_timezone_names\nWHERE abbrev IN ('PDT', 'PST') \nORDER BY name DESC\nLIMIT 5;\n```\n\n```{sql, connection=pg}\nSELECT \n    '2020-09-01 00:00:00 -0' AT TIME ZONE 'US/Pacific',\n    '2020-09-01 00:00:00 -0' AT TIME ZONE 'PDT';\n```\n\n```{sql, connection=pg}\nSELECT     \n    '2020-12-01 00:00:00 -0' AT TIME ZONE 'US/Pacific',\n    '2020-12-01 00:00:00 -0' AT TIME ZONE 'PST';\n```\n### Date and Timestamp Format Conversions\n\nAs discussed in @tanimura2021sql, PostgreSQL has a rich array of functions for converting dates and times and extracting such information as months and days of the week.\n\n```{sql, connection=pg}\nSELECT date_trunc('month','2020-10-04 12:33:35'::timestamp);\n```\nOne such function \n\n```{r}\na_time_df <- tbl(pg, sql(\"SELECT '2020-10-04 12:33:35'::timestamp AS a_time\"))\na_time_df %>% \n  mutate(a_trunced_time = date_trunc('month', a_time))\n\na_time_df %>% \n  mutate(a_trunced_time = date_trunc('month', a_time)) %>%\n  show_query()\n\na_time_df %>%\n  collect()\n```\n\n\n```{r}\na_time_df <- tbl(pg, sql(\"SELECT '2020-10-04 12:33:35 US/Pacific'::timestamp with time zone AS a_time\"))\n\na_time_df %>% \n  mutate(a_trunced_time = date_trunc('month', a_time)) \n\na_time_df %>% \n  mutate(a_trunced_time = date_trunc('month', a_time)) %>%\n  show_query()\n\na_time_df %>%\n  collect()\n```\n\n```{r}\na_time_df %>%\n  mutate(new_time = a_time + sql(\"interval '3 hours'\")) %>%\n  collect()\n```\n## The Retail Sales Data Set\n\n```{sql, connection=pg}\nSELECT sales_month, sales\nFROM retail_sales\nWHERE kind_of_business = 'Retail and food services sales, total'\nORDER BY 1\n```\n\n```{r}\nretail_sales <- tbl(pg, \"retail_sales\")\nretail_sales %>%\n  filter(kind_of_business == 'Retail and food services sales, total') %>%\n  select(sales_month, sales) %>%\n  arrange(sales_month) %>%\n  ggplot(aes(x = sales_month, y = sales)) +\n  geom_line()\n```\n\n```{sql, connection=pg}\nSELECT date_part('year',sales_month) as sales_year,\n    sum(sales) as sales\nFROM retail_sales\nWHERE kind_of_business = 'Retail and food services sales, total'\nGROUP BY 1\n;\n```\n\n```{r}\nretail_sales %>%\n  filter(kind_of_business == 'Retail and food services sales, total') %>%\n  mutate(sales_year = date_part('year', sales_month)) %>%\n  group_by(sales_year) %>%\n  summarize(sales = sum(sales, na.rm = TRUE)) %>%\n  arrange(sales_year) %>%\n  ggplot(aes(x = sales_year, y = sales)) +\n  geom_line()\n```\n\n```{sql, connection=pg}\nSELECT date_part('year',sales_month) as sales_year, \n  kind_of_business, sum(sales) as sales\nFROM retail_sales\nWHERE kind_of_business IN \n          ('Book stores',\n           'Sporting goods stores',\n           'Hobby, toy, and game stores')\nGROUP BY 1,2\nORDER BY 1;\n```\n\n\n```{r}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c('Book stores',\n             'Sporting goods stores',\n             'Hobby, toy, and game stores')) %>%\n  mutate(sales_year = date_part('year', sales_month)) %>%\n  group_by(sales_year, kind_of_business) %>%\n  summarize(sales = sum(sales, na.rm = TRUE), .groups = \"drop\") %>%\n  arrange(sales_year) %>%\n  ggplot(aes(x = sales_year, y = sales, color = kind_of_business)) +\n  geom_line() +\n  theme(legend.position = \"top\")\n```\n\n```{sql, connection=pg}\nSELECT sales_month, kind_of_business, sales\nFROM retail_sales\nWHERE kind_of_business IN ('Men''s clothing stores','Women''s clothing stores')\nORDER BY 1,2;\n```\n\n```{r}\nretail_sales %>%\n  filter(kind_of_business %in% c(\"Men's clothing stores\",\n                                 \"Women's clothing stores\")) %>%\n  select(sales_month, kind_of_business, sales) %>%\n  arrange(sales_month) %>%\n  ggplot(aes(x = sales_month, y = sales, color = kind_of_business)) +\n  geom_line() +\n  theme(legend.position = \"top\")\n```\n\n```{sql, connection=pg}\nSELECT date_part('year',sales_month) as sales_year,\n  kind_of_business, sum(sales) as sales\nFROM retail_sales\nWHERE kind_of_business IN \n        ('Men''s clothing stores',\n        'Women''s clothing stores')\nGROUP BY 1, 2\nORDER BY 1, 2;\n```\n\n```{r}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  mutate(sales_year = date_part('year', sales_month)) %>%\n  group_by(sales_year, kind_of_business) %>%\n  summarize(sales = sum(sales, na.rm = TRUE), .groups = \"drop\") %>%\n  arrange(sales_year) %>%\n  ggplot(aes(x = sales_year, y = sales, color = kind_of_business)) +\n  geom_line() +\n  theme(legend.position = \"top\")\n```\n\n```{sql, connection=pg}\nSELECT date_part('year', sales_month) AS sales_year,\n  sum(CASE WHEN kind_of_business = 'Women''s clothing stores' \n          then sales \n          END) AS womens_sales,\n  sum(CASE WHEN kind_of_business = 'Men''s clothing stores' \n          then sales \n          END) AS mens_sales\nFROM retail_sales\nWHERE kind_of_business IN \n   ('Men''s clothing stores',\n    'Women''s clothing stores')\nGROUP BY 1\nORDER BY 1;\n```\n\n```{r}\npivoted_sales <-\n  retail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  mutate(kind_of_business = if_else(kind_of_business == \"Women's clothing stores\",\n                                    \"womens\", \"mens\"),\n         sales_year = date_part('year', sales_month)) %>%\n  group_by(sales_year, kind_of_business) %>%\n  summarize(sales = sum(sales, na.rm = TRUE), .groups = \"drop\") %>%\n  pivot_wider(id_cols = \"sales_year\",\n              names_from = \"kind_of_business\",\n              names_glue = \"{kind_of_business}_{.value}\",\n              values_from = \"sales\")  \n\npivoted_sales %>%\n  show_query()\n\npivoted_sales %>%\n  arrange(sales_year) %>%\n  collect(n = 10) %>%\n  knitr::kable()\n```\n\n```{r}\npivoted_sales %>%\n  filter(sales_year <= 2019) %>%\n  group_by(sales_year) %>%\n  mutate(womens_minus_mens = womens_sales - mens_sales,\n         mens_minus_womens = mens_sales - womens_sales) %>%\n  select(sales_year, womens_minus_mens, mens_minus_womens) %>%\n  arrange(sales_year) %>%\n  ggplot(aes(y = womens_minus_mens, x = sales_year)) +\n  geom_line()\n```\n\n```{r}\npivoted_sales %>%\n  filter(sales_year <= 2019) %>%\n  group_by(sales_year) %>%\n  mutate(womens_times_of_mens = womens_sales / mens_sales) %>%\n  arrange(sales_year) %>%\n  ggplot(aes(y = womens_times_of_mens, x = sales_year)) +\n  geom_line()\n```\n```{r}\npivoted_sales %>%\n  filter(sales_year <= 2019) %>%\n  group_by(sales_year) %>%\n  mutate(womens_pct_of_mens = (womens_sales / mens_sales - 1) * 100) %>%\n  arrange(sales_year) %>%\n  ggplot(aes(y = womens_pct_of_mens, x = sales_year)) +\n  geom_line()\n```\n```{r}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  group_by(sales_month) %>%\n  mutate(total_sales = sum(sales)) %>%\n  ungroup() %>%\n  mutate(pct_total_sales = sales * 100 / total_sales) %>%\n  select(sales_month, kind_of_business, pct_total_sales) %>%\n  collect(n = 3)\n```\n\n```{r}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  group_by(sales_month) %>%\n  mutate(total_sales = sum(sales)) %>%\n  ungroup() %>%\n  mutate(pct_total_sales = sales * 100 / total_sales) %>%\n  show_query()\n```\n\n```{r}\nretail_sales %>%\n  filter(kind_of_business %in% \n           c(\"Men's clothing stores\",\n             \"Women's clothing stores\")) %>%\n  group_by(sales_month) %>%\n  mutate(total_sales = sum(sales)) %>%\n  ungroup() %>%\n  mutate(pct_total_sales = sales * 100 / total_sales) %>%\n  ggplot(aes(y = pct_total_sales, x = sales_month, color = kind_of_business)) +\n  geom_line()\n```\n\n```{r}\nretail_sales %>%\n  filter(kind_of_business == \"Women's clothing stores\") %>%\n  mutate(sales_year = date_part('year',sales_month)) %>%\n  group_by(sales_year) %>%\n  summarize(sales = sum(sales, na.rm = TRUE)) %>%\n  ungroup() %>%\n  window_order(sales_year) %>%\n  mutate(index_sales = first(sales),\n         pct_from_index = (sales/index_sales - 1) * 100)\n```\n\n```{r}\nretail_sales %>%\n  filter(kind_of_business %in% c(\"Women's clothing stores\",\n                                 \"Men's clothing stores\"),\n         sales_month <= '2019-12-31') %>%\n  mutate(sales_year = date_part('year',sales_month)) %>%\n  group_by(kind_of_business, sales_year) %>%\n  summarize(sales = sum(sales, na.rm = TRUE), .groups = \"drop\") %>%\n  group_by(kind_of_business) %>%\n  window_order(sales_year) %>%\n  mutate(index_sales = first(sales),\n         pct_from_index = (sales/index_sales - 1) * 100) %>%\n  ungroup() %>%\n  ggplot(aes(y = pct_from_index, x = sales_year, color = kind_of_business)) +\n  geom_line()\n```\n```{r}\nretail_sales %>%\n  filter(kind_of_business == \"Women's clothing stores\") %>%\n  window_order(sales_month) %>%\n  window_frame(-11, 0) %>%\n  mutate(moving_avg = mean(sales, na.rm = TRUE),\n         records_count = n()) %>%\n  select(sales_month, moving_avg, records_count) %>%\n  collect(n = 10)\n```"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"chapter_3.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.269","bibliography":["references.bib"],"editor":"visual","theme":"cosmo"},"extensions":{"book":{"multiFile":true}}},"pdf":{"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"chapter_3.pdf"},"language":{},"metadata":{"block-headings":true,"bibliography":["references.bib"],"editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{}}}}}